(self.webpackChunk=self.webpackChunk||[]).push([[138],{138:(t,e,s)=>{"use strict";s.r(e),s.d(e,{Scene:()=>rs});var i=s(5879),n=s(1401),o=s(3131),r=s(7365),a=s(2010),h=s(2306),l=s(9046),c=s(140),d=s(4078),u=s(6454),p=s(6173),m=s(1661),y=s(5920),b=s(1516),g=s(5785),f=s(8490),v=s(6679),w=s(6881),x=s(1158),j=s(9203),E=s(7092),D=s(1138),P=s(1557),k=s(1301),_=s(4595),S=s(3662);const M=new D.F,L=new w.P,z=new P.i;z.params.Line.threshold=1,z.params.Points.threshold=1;const C={background:1579035,lighting:16777215,emissive:468276,meshTempHover:10342381,point:16777215,selpoint:16711680,line:16777215,mesh:10342381,dimension:255,plane:16776960,planeBorder:3026432,opacity:.02},A={emissive:3421191,point:65280,selpoint:16711680,line:65280,mesh:16430593,dimension:65280,plane:16776960,planeBorder:9539840,opacity:.06},T=new g.n({linewidth:1,color:C.line,depthTest:!1}),B=new v.U({color:C.point,size:4,depthTest:!1}),I=(t,e=!0)=>{const s=new h.w((new l.u).setAttribute("position",new c.a$(t||3,3)),B.clone());return s.name="p"+id++,s.userData.type="point",s.visible=e,s.renderOrder=1,s},O=(t=1)=>{const e=new k.x((new l.u).setAttribute("position",new c.a$(3*(t+1),3)),T.clone());return e.name="l"+id++,e.userData.type="line",e.renderOrder=1,e};async function F(...t){function e(){for(let e=t.length-1;e>=0;e--){const i=t[e];let n=0;for(let o in s){if(!i[o]||s[o]>i[o]){t.splice(e,1);break}s[o]==i[o]&&(n+=1)}if(n==Object.keys(i).length)return!0}return!1}const s={};let i=this.selected.slice();for(let t of i){const e=t.userData.type;s[e]?s[e]+=1:s[e]=1}if(e())return i;let n=!1;for(;t.length&&!n;){let t,o,r;try{t=await new Promise(((t,e)=>{r=t=>"Escape"==t.key&&e(),o=e=>this.hovered.length&&t(this.hovered[0]),this.canvas.addEventListener("pointerdown",o),window.addEventListener("keydown",r)})),i.push(t);const n=t.userData.type;if(s[n]?s[n]+=1:s[n]=1,e())return i}catch(t){n=!0}this.canvas.removeEventListener("pointerdown",o),window.removeEventListener("keydown",r)}return null}function U(t,e,s=!0){let i=1==e?A:C;switch(t.userData.type){case"plane":t.material.opacity=i.opacity,t.children[0].material.color.set(i.planeBorder);break;case"sketch":t.traverse((t=>{"line"==t.userData.type&&t.material.color.set(i.line)}));break;case"mesh":if(!s)break;t.material.emissive.set(i.emissive);case"point":t.material.color.set(i[t.userData.type]),t.material.size=e?8:4;default:t.material.color.set(i[t.userData.type])}}const R=new _.j({uniforms:{color:{value:new S.I(16711680)},edgeColor:{value:new S.I(7798784)},pointWidth:{value:4},edgeSize:{value:4}},vertexShader:"\n  uniform float edgeSize;\n  uniform float pointWidth;\n  void main() {\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_PointSize = (pointWidth + edgeSize);\n    gl_Position = projectionMatrix * mvPosition;\n  }\n",fragmentShader:"\n  uniform vec3 color;\n  uniform vec3 edgeColor;\n  uniform float edgeSize;\n  uniform float pointWidth;\n  void main() {\n    gl_FragColor = vec4(color, 1.0);\n    float distance = length(2.0 * gl_PointCoord - 1.0);\n    float totalWidth = pointWidth + edgeSize;\n    float edgeStart = pointWidth;\n    float edgeEnd = pointWidth + 2.0;\n    float sEdge = smoothstep(edgeStart, edgeEnd, distance * totalWidth);\n    // transition from edgeColor to color along the edge\n    gl_FragColor = ( vec4(edgeColor, 1.0) * sEdge) + ((1.0 - sEdge) * gl_FragColor);\n\n    if (distance > 1.0) {\n      discard;\n    }\n  }\n",depthTest:!1});window.rc=z;function q(t,e){const[s,i,n,o]=e;i.geometry.attributes.position.set(t),i.geometry.attributes.position.needsUpdate=!0,i.geometry.computeBoundingSphere();const[r,a]=function(t,e,s=30){const i=e[0]-t[0],n=e[1]-t[1],o=Math.sqrt(i**2+n**2),r=(Math.atan2(n,i)-Math.PI/2)%(2*Math.PI);let a=r-Math.PI/6,h=r+Math.PI/6;a=a<0?a+2*Math.PI:a,h=h<0?h+2*Math.PI:a;const l=Math.tan(Math.PI/3),c=(t[0]+e[0]-n*l)/2,d=(t[1]+e[1]+i*l)/2,u=o,p=Math.PI/3;let m=new Float32Array(3*(s+1));for(let t=0;t<=s;t++){const e=a+t/s*p;m[3*t]=c+u*Math.cos(e),m[3*t+1]=d+u*Math.sin(e)}return[m,[c,d]]}(s.geometry.attributes.position.array,i.geometry.attributes.position.array);o.geometry.attributes.position.set(r),o.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.position.set(a),n.geometry.attributes.position.needsUpdate=!0,n.geometry.computeBoundingSphere()}const H=new D.F,N=new D.F,G=new D.F,Y=new D.F,V=new D.F,W=new D.F,X=new D.F,J=new D.F;let Z,$,K,Q,tt;function et(t,e,s,i=30){const n=[t[0]-s[0],t[1]-s[1]],o=[e[0]-s[0],e[1]-s[1]];let r=Math.atan2(n[1],n[0]),a=Math.atan2(o[1],o[0]);const h=Math.sqrt(n[0]**2+n[1]**2);let l=a-r;l<=0&&(l+=2*Math.PI);let c=new Float32Array(3*(i+1));for(let t=0;t<=i;t++){const e=r+t/i*l;c[3*t]=s[0]+h*Math.cos(e),c[3*t+1]=s[1]+h*Math.sin(e)}return c}function st(t,e){const[s,i,n]=e;i.geometry.attributes.position.set(t),i.geometry.attributes.position.needsUpdate=!0,i.geometry.computeBoundingSphere(),n.geometry.attributes.position.set(t,3),n.geometry.attributes.position.needsUpdate=!0,n.geometry.computeBoundingSphere()}function it(t,e){if(!e&&1!==t.buttons)return;let s;this.canvas.addEventListener("pointermove",this.drawPreClick2),this.canvas.addEventListener("pointerdown",this.drawOnClick2,{once:!0}),s=e||(this.hovered.length&&!this.subsequent?this.hovered[this.hovered.length-1].geometry.attributes.position.array:this.getLocation(t).toArray()),"line"==this.mode?(this.toPush=function(t){const e=I();e.matrixAutoUpdate=!1,e.userData.constraints=[];const s=I();s.matrixAutoUpdate=!1,s.userData.constraints=[];const i=O();return i.matrixAutoUpdate=!1,i.frustumCulled=!1,i.userData.constraints=[],i.geometry.attributes.position.set(t),e.geometry.attributes.position.set(t),[e,s,i]}(s),this.subsequent&&(this.constraints.set(++this.c_id,["points_coincident",-1,[this.obj3d.children[this.obj3d.children.length-2].name,this.toPush[0].name,-1,-1]]),this.obj3d.children[this.obj3d.children.length-2].userData.constraints.push(this.c_id),this.toPush[0].userData.constraints.push(this.c_id))):"arc"==this.mode&&(this.toPush=function(t){const e=I(t);e.matrixAutoUpdate=!1,e.userData.constraints=[];const s=I();s.matrixAutoUpdate=!1,s.userData.constraints=[];const i=O(30);i.frustumCulled=!1,i.userData.constraints=[];const n=I();return n.matrixAutoUpdate=!1,n.userData.constraints=[],[e,s,n,i]}(s)),this.hovered.length&&!this.subsequent&&(this.constraints.set(++this.c_id,["points_coincident",-1,[this.hovered[this.hovered.length-1].name,this.toPush[0].name,-1,-1]]),this.hovered[this.hovered.length-1].userData.constraints.push(this.c_id),this.toPush[0].userData.constraints.push(this.c_id),this.updateOtherBuffers()),this.updatePoint=this.obj3d.children.length,this.obj3d.add(...this.toPush),this.linkedObjs.set(this.l_id,[this.mode,this.toPush.map((t=>t.name))]);for(let t of this.toPush)t.userData.l_id=this.l_id;this.l_id+=1}function nt(t){const e=this.getLocation(t).toArray();"line"==this.mode?st(e,this.toPush):"arc"==this.mode&&q(e,this.toPush),this.scene.render()}function ot(t){if(1!==t.buttons)return;let e;this.canvas.removeEventListener("pointermove",this.drawPreClick2),this.updatePointsBuffer(this.updatePoint),this.updateOtherBuffers(),this.toPush.forEach((t=>{t.layers.enable(2)})),this.hovered.length&&(this.constraints.set(++this.c_id,["points_coincident",-1,[this.hovered[this.hovered.length-1].name,this.toPush[1].name,-1,-1]]),this.hovered[this.hovered.length-1].userData.constraints.push(this.c_id),this.toPush[1].userData.constraints.push(this.c_id),this.updateOtherBuffers(),e=this.hovered[this.hovered.length-1].geometry.attributes.position.array),"line"==this.mode?(this.subsequent=!0,e?(st(e,this.toPush),this.drawOnClick1(null,e)):this.drawOnClick1(t)):"arc"==this.mode&&(e&&q(e,this.toPush),function(t,e){W.set(t.geometry.attributes.position.array[0],t.geometry.attributes.position.array[1]),X.set(e.geometry.attributes.position.array[0],e.geometry.attributes.position.array[1]),J.subVectors(X,W),G.set(-J.y,J.x),H.addVectors(W,J.multiplyScalar(.5))}(this.toPush[0],this.toPush[1]),this.canvas.addEventListener("pointermove",this.drawPreClick3),this.canvas.addEventListener("pointerdown",this.drawOnClick3,{once:!0}))}function rt(t){const e=this.getLocation(t);tt=function(t,e){const[s,i,n,o]=e;return V.set(t.x-W.x,t.y-W.y),K=J.cross(V)<0?1:0,Y.set(-V.y,V.x),N.addVectors(W,V.multiplyScalar(.5)),Z=G.cross(Y),$=0===Z?.5:V.subVectors(N,H).cross(G)/Z,n.geometry.attributes.position.set(V.addVectors(N,Y.multiplyScalar($)).toArray()),n.geometry.attributes.position.needsUpdate=!0,n.geometry.computeBoundingSphere(),K?(Q=et(s.geometry.attributes.position.array,i.geometry.attributes.position.array,n.geometry.attributes.position.array),s.userData.start=!0,i.userData.start=!1):(Q=et(i.geometry.attributes.position.array,s.geometry.attributes.position.array,n.geometry.attributes.position.array),i.userData.start=!0,s.userData.start=!1),o.geometry.attributes.position.set(Q),o.geometry.attributes.position.needsUpdate=!0,o.geometry.computeBoundingSphere(),o.userData.ccw=K,K}(e,this.toPush),this.scene.render()}function at(t){if(1===t.buttons){if(this.canvas.removeEventListener("pointermove",this.drawPreClick3),!tt){let t;const e=this.linkedObjs.get(this.l_id-1);t=e[1][0],e[1][0]=e[1][1],e[1][1]=t,this.linkedObjs.set(this.l_id-1,e);let s=5*(this.linkedObjs.size-1);t=this.linksBuf[s+1],this.linksBuf[s+1]=this.linksBuf[s+2],this.linksBuf[s+2]=t}this.updatePoint=this.obj3d.children.length,this.canvas.addEventListener("pointerdown",this.drawOnClick1,{once:!0})}}function ht(){""!=this.mode&&(["line","arc"].includes(this.mode)&&this.delete(this.obj3d.children[this.updatePoint]),this.canvas.removeEventListener("pointerdown",this.drawOnClick1),this.canvas.removeEventListener("pointermove",this.drawPreClick2),this.canvas.removeEventListener("pointerdown",this.drawOnClick2),this.canvas.removeEventListener("pointermove",this.drawPreClick3),this.canvas.removeEventListener("pointerdown",this.drawOnClick3),this.scene.render(),this.subsequent=!1,this.toPush=[],this.snap=!1,this.mode="")}const lt=new g.n({linewidth:1,color:C.dimension}),ct=new v.U({color:C.dimension,size:4});let dt;async function ut(){let t,e,s,i=await this.awaitSelection({point:2},{point:1,line:1},{line:2});if(null==i)return;if(i.every((t=>"line"==t.userData.type)))t=new y.e((new l.u).setAttribute("position",new c.a$(Array(2*(Rt+2)*3).fill(-.001),3)),lt.clone()),dt=le(i),e=["angle",dt,[-1,-1,i[0].name,i[1].name],0],s="a";else{let n;if(t=new y.e((new l.u).setAttribute("position",new c.a$(Array(24).fill(-.001),3)),lt.clone()),i.every((t=>"point"==t.userData.type))){dt=0;for(let t=0;t<3;t++)dt+=(i[0].geometry.attributes.position.array[t]-i[1].geometry.attributes.position.array[t])**2;dt=Math.sqrt(dt),e=["pt_pt_distance",dt,[i[0].name,i[1].name,-1,-1]]}else{n="point"==i[0].userData.type?[0,1]:[1,0];const t=i[n[0]].geometry.attributes.position.array,s=i[n[1]].geometry.attributes.position.array;ft.set(s[0],s[1]),xt.set(s[3],s[4]),mt.set(t[0],t[1]),At=xt.clone().sub(ft).normalize(),jt=mt.clone().sub(ft),Pt=At.multiplyScalar(jt.dot(At)),Bt=jt.clone().sub(Pt),dt=Math.sign(Bt.y)*Math.sqrt(Bt.x**2+Bt.y**2),e=["pt_line_distance",dt,[i[n[0]].name,-1,i[n[1]].name,-1]]}s="d"}const n=new h.w((new l.u).setAttribute("position",new c.a$(3,3)),ct.clone());t.userData.ids=i.map((t=>t.name)),t.userData.type="dimension",t.userData.dimType=s,n.userData.type="dimension",n.userData.dimType=s,t.layers.enable(2),n.layers.enable(2),this.dimGroup.add(t).add(n);const o=this._onMoveDimension(n,t,!0);let r,a;n.label=document.createElement("div"),n.label.textContent=dt.toFixed(3),n.label.contentEditable=!0,this.labelContainer.append(n.label);let d=await new Promise((t=>{r=()=>{"a"==n.userData.dimType?n.userData.offset=qt[5].toArray():n.userData.offset=Dt.toArray(),t(!0)},a=e=>"Escape"==e.key&&t(!1),this.canvas.addEventListener("pointermove",o),this.canvas.addEventListener("pointerdown",r),window.addEventListener("keydown",a)}));this.canvas.removeEventListener("pointermove",o),this.canvas.removeEventListener("pointerdown",r),window.removeEventListener("keydown",a),n.geometry.computeBoundingSphere(),t.geometry.computeBoundingSphere(),d?("h"==t.userData.dimType?(e[0]="h_dist",e[1]=xt.x-ft.x):"v"==t.userData.dimType&&(e[0]="v_dist",e[1]=xt.y-ft.y),this.constraints.set(++this.c_id,e),i[0].userData.constraints.push(this.c_id),i[1].userData.constraints.push(this.c_id),this.updateOtherBuffers(),t.name=this.c_id,n.name=this.c_id,n.label.addEventListener("focus",this.updateDim(this.c_id))):(this.dimGroup.children.splice(this.dimGroup.children.length-2,2).forEach((t=>{t.geometry.dispose(),t.material.dispose()})),this.labelContainer.removeChild(this.labelContainer.lastChild),this.scene.render()),"dimension"==this.mode&&this.drawDimension()}function pt(t){return e=>{let s=e.target.textContent;document.addEventListener("keydown",(i=>{if("Enter"==i.key){i.preventDefault();const n=this.constraints.get(t);n[1]=parseFloat(e.target.textContent),s=n[1],this.constraints.set(t,n),this.updateOtherBuffers(),this.solve(),this.scene.render(),e.target.blur(),this.updateBoundingSpheres()}else"Escape"==i.key&&(e.target.textContent=s,getSelection().empty(),e.target.blur())}))}}const mt=new D.F;let yt;function bt(t,e,s){yt=e.userData.ids;let i,n,o=this.obj3d.children[this.objIdx.get(yt[0])].geometry.attributes.position.array,r=this.obj3d.children[this.objIdx.get(yt[1])].geometry.attributes.position.array;return n="a"==e.userData.dimType?ne:Ut,a=>{i=this.getLocation(a),mt.set(i.x,i.y),n(e,t,o,r,null,s),this.scene.render()}}function gt(){const t=0==this.labelContainer.childElementCount,e=this.dimGroup.children;let s,i;for(let n=0;n<e.length;n+=2){t&&(s=e[n+1],i=this.constraints.get(s.name)[1],s.label=document.createElement("div"),s.label.textContent=i.toFixed(3),s.label.contentEditable=!0,this.labelContainer.append(s.label),s.label.addEventListener("focus",this.updateDim(this.c_id))),yt=e[n].userData.ids;let o,r=this.obj3d.children[this.objIdx.get(yt[0])].geometry.attributes.position.array,a=this.obj3d.children[this.objIdx.get(yt[1])].geometry.attributes.position.array;o="a"==e[n].userData.dimType?ne:Ut,o(e[n],e[n+1],r,a,e[n+1].userData.offset)}}const ft=new D.F;let vt;const wt=new D.F,xt=new D.F;let jt,Et,Dt,Pt,kt,_t,St,Mt,Lt,zt,Ct,At,Tt,Bt,It,Ot,Ft;function Ut(t,e,s,i,n,o){const r=t.geometry.attributes.position,a=e.geometry.attributes.position;n&&(s.length<i.length?mt.set(s[0]+n[0],s[1]+n[1]):mt.set(i[0]+n[0],i[1]+n[1]));let h=null;if(s.length==i.length)switch(ft.set(s[0],s[1]),xt.set(i[0],i[1]),o&&((mt.x-ft.x)*(mt.x-xt.x)>0&&(mt.y-ft.y)*(mt.y-xt.y)<0?(t.userData.dimType="v",e.userData.dimType="v",e.label.textContent=(xt.y-ft.y).toFixed(3)):(mt.x-ft.x)*(mt.x-xt.x)<0&&(mt.y-ft.y)*(mt.y-xt.y)>0?(t.userData.dimType="h",e.userData.dimType="h",e.label.textContent=(xt.x-ft.x).toFixed(3)):(t.userData.dimType="d",e.userData.dimType="d",e.label.textContent=dt.toFixed(3))),t.userData.dimType){case"v":h=[s[0]+1,s[1]];break;case"h":h=[s[0],s[1]+1];break;default:At=xt.clone().sub(ft).normalize(),Dt=mt.clone().sub(xt),Pt=At.multiplyScalar(Dt.dot(At)),Bt=Dt.clone().sub(Pt),St=ft.clone().add(Bt),Lt=St.toArray(),Mt=xt.clone().add(Bt),zt=Mt.toArray(),Ct=mt.toArray(),It=St.distanceToSquared(mt),Ot=Mt.distanceToSquared(mt),Ft=St.distanceToSquared(Mt),r.array.set(ft.toArray(),0)}(s.length!=i.length||h)&&(h?(ft.set(s[0],s[1]),wt.set(...h),xt.set(i[0],i[1])):s.length>i.length?(ft.set(s[0],s[1]),wt.set(s[3],s[4]),xt.set(i[0],i[1])):(ft.set(i[0],i[1]),wt.set(i[3],i[4]),xt.set(s[0],s[1])),Tt=wt.clone().sub(ft),vt=ft.clone().addScaledVector(Tt,.5),Tt.normalize(),jt=xt.clone().sub(vt),Pt=Tt.multiplyScalar(jt.dot(Tt)),At=jt.clone().sub(Pt),Ft=At.lengthSq(),At.normalize(),Et=mt.clone().sub(vt),kt=At.clone().multiplyScalar(Et.dot(At)),Dt=mt.clone().sub(xt),_t=At.clone().multiplyScalar(Dt.dot(At)),Lt=mt.clone().sub(kt).toArray(),zt=mt.clone().sub(_t).toArray(),Ct=mt.toArray(),It=kt.lengthSq(),Ot=_t.lengthSq(),r.array.set(vt.toArray(),0)),r.array.set(Lt,3),r.array.set(Lt,6),r.array.set(zt,9),r.array.set(zt,12),r.array.set(xt.toArray(),15),Ft>=It&&Ft>=Ot?r.array.set(Ct,18):It>Ot?r.array.set(zt,18):r.array.set(Lt,18),r.array.set(Ct,21),r.needsUpdate=!0,a.array.set(Ct),a.needsUpdate=!0}const Rt=12,qt=Array(6);for(let t=0;t<qt.length;t++)qt[t]=new D.F;const Ht=Array(3),Nt=new D.F;let Gt,Yt,Vt,Wt,Xt,Jt,Zt,$t,Kt,Qt,te,ee,se,ie;function ne(t,e,s,i,n){const o=t.geometry.attributes.position,r=e.geometry.attributes.position;for(Yt=0;Yt<4;)Gt=0==Yt?s:i,qt[Yt++].set(Gt[0],Gt[1]),qt[Yt++].set(Gt[3]-Gt[0],Gt[4]-Gt[1]);for(Xt=qt[3].cross(qt[1]),Wt=0===Xt?.5:Nt.subVectors(qt[0],qt[2]).cross(qt[3])/Xt,Jt=qt[4].addVectors(qt[0],qt[1].clone().multiplyScalar(Wt)),n&&mt.set(Jt.x+n[0],Jt.y+n[1]),qt[5].subVectors(mt,Jt),Zt=qt[5].length(),Vt=1,Yt=0;Vt<qt.length;Vt+=2,Yt++)Ht[Yt]=Math.atan2(qt[Vt].y,qt[Vt].x);$t=he(Ht[1]-Ht[0]),Kt=he(Ht[2]-(Ht[0]+$t/2)),Qt=Math.abs(Kt)<Math.PI/2?0:Math.PI,te=he(Ht[2]-(Ht[0]+Qt)),ee=he(Ht[2]-(Ht[0]+$t+Qt)),$t*te<0?(se=Ht[0]+te+Qt,ie=$t-te):$t*ee>0?(se=Ht[0]+Qt,ie=$t+ee):(se=Ht[0]+Qt,ie=$t),Vt=0,o.array[Vt++]=Jt.x+Zt*Math.cos(se),o.array[Vt++]=Jt.y+Zt*Math.sin(se),Vt++;let a=se+1/Rt*ie;for(o.array[Vt++]=Jt.x+Zt*Math.cos(a),o.array[Vt++]=Jt.y+Zt*Math.sin(a),Vt++,Yt=2;Yt<=Rt;Yt++)o.array[Vt++]=o.array[Vt-4],o.array[Vt++]=o.array[Vt-4],Vt++,a=se+Yt/Rt*ie,o.array[Vt++]=Jt.x+Zt*Math.cos(a),o.array[Vt++]=Jt.y+Zt*Math.sin(a),Vt++;for(Yt=0;Yt<2;Yt++)o.array[Vt++]=qt[2*Yt].x,o.array[Vt++]=qt[2*Yt].y,Vt++,o.array[Vt++]=Jt.x+Zt*Math.cos(Ht[Yt]+Qt),o.array[Vt++]=Jt.y+Zt*Math.sin(Ht[Yt]+Qt),Vt++;o.needsUpdate=!0,r.array.set(mt.toArray()),r.needsUpdate=!0}const oe=2*Math.PI,re=2*-Math.PI,ae=-Math.PI;function he(t){return t>Math.PI?t=re+t:t<ae&&(t=oe+t),t}const le=t=>{for(let e=0;e<2;e++){const s=t[e].geometry.attributes.position.array;qt[2*e].set(...s.slice(0,2)),qt[2*e+1].set(s[3]-s[0],s[4]-s[1])}const e=Math.atan2(qt[1].y,qt[1].x),s=Math.atan2(qt[3].y,qt[3].x);let i=Math.abs(s-e);return i>Math.PI&&(i=2*Math.PI-i),i/Math.PI*180};let ce,de;function ue(t){if(t.buttons)return;let e;z.setFromCamera(new D.F((t.clientX-this.rect.left)/this.rect.width*2-1,-(t.clientY-this.rect.top)/this.rect.height*2+1),this.camera),"sketch"!=this.obj3d.userData.type?(z.layers.set(1),e=z.intersectObjects(this.obj3d.children,!0)):(z.layers.set(2),e=z.intersectObjects([...this.dimGroup.children,...this.obj3d.children]));let s=[];const i=1e-4;if(e.length){let t=1/0;for(let n=0;n<e.length;n++)if(e[n].distanceToRay)if(e[n].distanceToRay<t-i){if(s=[n],"sketch"!=this.obj3d.userData.type)break;t=e[n].distanceToRay}else e[n].distanceToRay<t+i&&s.push(n);s.length||this.snap||s.push(0)}if(s.length){if(!this.hovered.length||"number"==typeof this.hovered[0]&&this.hovered[0]!=e[s[0]].index||"object"==typeof this.hovered[0]&&this.hovered[0]!=e[s[0]].object){for(let t=0;t<this.hovered.length;t++){const e=this.hovered[t];"object"!=typeof e||this.selected.includes(e)||U(e,0)}this.hovered=[];for(let t=0;t<s.length;t++){let i=e[s[t]].object;U(i,1,!1),"sketch"!=this.obj3d.userData.type&&("point"==i.userData.type?(ce=i.geometry.attributes.position.array.slice(3*e[s[t]].index,3*e[s[t]].index+3),this.selpoints[0].geometry.attributes.position.array.set(ce),this.selpoints[0].matrix=i.parent.matrix,this.selpoints[0].geometry.attributes.position.needsUpdate=!0,this.selpoints[0].visible=!0,i=e[s[t]].index,this.selpoints[0].idx=i):this.selpoints[0].visible=!1),this.hovered.push(i)}this.obj3d.dispatchEvent({type:"change"})}}else if(this.hovered.length){for(let t=0;t<this.hovered.length;t++){const e=this.hovered[t];"number"==typeof e?this.selpoints[0].visible=!1:this.selected.includes(e)||U(e,0)}this.hovered=[],this.obj3d.dispatchEvent({type:"change"})}}function pe(t){if(!(this.mode&&"dimension"!=this.mode||1!=t.buttons))if(this.hovered.length){let t=this.hovered[this.hovered.length-1];if("object"!=typeof t){const e=this.selpoints[this.fptIdx%3+1],s=this.selpoints[0];e.geometry.attributes.position.array.set(s.geometry.attributes.position.array),e.matrix=s.matrix,e.geometry.attributes.position.needsUpdate=!0,e.visible=!0,t=e,this.fptIdx++;const i=this.selected.indexOf(t);-1==i?this.selected.push(t):this.selected.splice(i,1,t)}else{const e=this.selected.indexOf(t);-1==e?(this.selected.push(t),this.setHover(t,1)):(this.setHover(this.selected[e],0),this.selected.splice(e,1))}if(this.obj3d.dispatchEvent({type:"change"}),"sketch"!=this.obj3d.userData.type)return;switch(t.userData.type){case"dimension":const t=this.dimGroup.children.indexOf(this.hovered[0]);t%2&&(this.onDragDim=this._onMoveDimension(this.dimGroup.children[t],this.dimGroup.children[t-1]),this.canvas.addEventListener("pointermove",this.onDragDim),this.canvas.addEventListener("pointerup",(()=>{var e;"a"==(e=this.dimGroup.children[t]).userData.dimType?e.userData.offset=qt[5].toArray():e.userData.offset=Dt.toArray(),this.onRelease()}))),de=this.dimGroup.children[t].label,de.style.zIndex=-1;break;case"point":this.canvas.addEventListener("pointermove",this.onDrag),this.canvas.addEventListener("pointerup",this.onRelease)}}else{for(let t=0;t<this.selected.length;t++){const e=this.selected[t];"selpoint"==e.userData.type?e.visible=!1:U(e,0),"sketch"!=e.userData.type||this.scene.store.getState().treeEntries.visible[e.name]||(e.visible=!1)}this.obj3d.dispatchEvent({type:"change"}),this.selected=[]}}function me(t){for(let e=0;e<this.hovered.length;e++){const s=this.hovered[e];this.ptsBuf.set(this.getLocation(t).toArray(),3*this.objIdx.get(s.name))}this.solve(),this.scene.render()}function ye(t){this.canvas.removeEventListener("pointermove",this.onDrag),this.canvas.removeEventListener("pointermove",this.onDragDim),this.canvas.removeEventListener("pointerup",this.onRelease),this.updateBoundingSpheres(),de&&(de.style.zIndex=0)}function be(){for(let t,e=0;e<this.selected.length;e++)t=this.selected[e],"selpoint"==t.userData.type?t.visible=!1:U(t,0);this.selected=[];for(let t=0;t<this.hovered.length;t++){U(this.hovered[t],0)}}async function ge(t){let e;if(void 0===t){if(e=await this.awaitSelection({point:2},{point:1,line:1}),null==e)return}else e=t;if(e.every((t=>"point"==t.userData.type)))this.constraints.set(++this.c_id,["points_coincident",-1,[e[0].name,e[1].name,-1,-1]]);else{const t="point"==e[0].userData.type?[0,1]:[1,0];this.constraints.set(++this.c_id,[void 0!==e[t[1]].userData.ccw?"pt_on_circle":"pt_on_line",-1,[e[t[0]].name,-1,e[t[1]].name,-1]])}e[1].userData.constraints.push(this.c_id),e[0].userData.constraints.push(this.c_id),this.updateOtherBuffers(),this.solve(),this.updateBoundingSpheres();for(let t=0;t<this.selected.length;t++){U(this.selected[t],0)}this.selected=[],this.scene.render()}async function fe(t=0){let e,s=await this.awaitSelection({point:2},{line:1});if(null!=s){e=1==this.selected.length?[-1,-1,s[0].name,-1]:[s[0].name,s[1].name,-1,-1],this.constraints.set(++this.c_id,[t?"vertical":"horizontal",-1,e]),s.forEach((t=>{t.userData.constraints.push(this.c_id)})),this.updateOtherBuffers(),this.solve(),this.updateBoundingSpheres();for(let t=0;t<this.selected.length;t++){U(this.selected[t],0)}this.selected=[],this.scene.render()}}async function ve(){let t=await this.awaitSelection({line:2});if(null==t)return;const e={};let s=-1;const i=[];let n,o;for(let r=0;r<2;r++){null==t[r].userData.ccw&&(s=r);const a=t[r].userData.l_id,h=this.linkedObjs.get(a)[1];for(let r=0;r<2;r++){const a=this.obj3d.children[this.objIdx.get(h[r])].userData.constraints;for(let r=0;r<a.length;r++){const l=this.constraints.get(a[r]);if("points_coincident"==l[0]){if(e[a[r]]){for(let t=0;t<2;t++)i[t]=this.obj3d.children[this.objIdx.get(l[2][t])].userData.start?0:1;if(o=0==s?[-1,-1,t[1].name,t[0].name]:[-1,-1,t[0].name,t[1].name],n=-1==s?"curve_curve_tangent":"arc_line_tangent",h.includes(l[2][1])&&0==s||!h.includes(l[2][1])&&0!=s){let t=i[0];i[0]=i[1],i[1]=t}break}e[a[r]]=!0}}}}this.constraints.set(++this.c_id,[n,-1,o,i[0],i[1]]),t.forEach((t=>{t.userData.constraints.push(this.c_id)})),this.updateOtherBuffers(),this.solve(),this.updateBoundingSpheres();for(let t=0;t<this.selected.length;t++){U(this.selected[t],0)}this.selected=[],this.scene.render()}function we(t,e){return e instanceof Map?{dataType:"Map",value:Array.from(e.entries())}:e}function xe(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.value):e}class je{constructor(t,e){if(this.ptsBuf=new Float32Array(3*this.max_pts).fill(NaN),this.linksBuf=new Float32Array(5*this.max_links).fill(NaN),this.constraintsBuf=new Float32Array(8*this.max_constraints).fill(NaN),this.plane=new x.J(new w.P(0,0,1),0),this.labelContainer=document.getElementById("labels"),void 0===e){this.obj3d=new a.Z,this.obj3d.name="s"+t.sid++,this.obj3d.userData.type="sketch",this.obj3d.matrixAutoUpdate=!1,this.objIdx=new Map,this.linkedObjs=new Map,this.l_id=0,this.constraints=new Map,this.c_id=1,this.obj3d.add(new a.Z),this.geomStartIdx=this.obj3d.children.length,this.obj3d.userData.geomStartIdx=this.geomStartIdx,this.dimGroup=this.obj3d.children[this.geomStartIdx-1],this.labels=[];const e=I();e.matrixAutoUpdate=!1,e.userData.constraints=[],this.obj3d.add(e),this.updatePointsBuffer()}else this.obj3d=e.obj3d,this.obj3d.inverse=e.obj3d.matrix.clone().invert(),this.objIdx=JSON.parse(e.objIdx,xe),this.linkedObjs=JSON.parse(e.linkedObjs,xe),this.l_id=e.l_id,this.constraints=JSON.parse(e.constraints,xe),this.c_id=e.c_id,this.geomStartIdx=this.obj3d.userData.geomStartIdx,this.dimGroup=this.obj3d.children[this.geomStartIdx-1],this.updatePointsBuffer(),this.updateOtherBuffers(),this.plane.applyMatrix4(this.obj3d.matrix);this.scene=t,this.camera=t.camera,this.canvas=t.canvas,this.rect=t.rect,this.bindHandlers(),this.selected=[],this.hovered=[],this.mode="",this.subsequent=!1}toJSON(){return{obj3d:this.obj3d,objIdx:JSON.stringify(this.objIdx,we),linkedObjs:JSON.stringify(this.linkedObjs,we),l_id:this.l_id,constraints:JSON.stringify(this.constraints,we),c_id:this.c_id}}bindHandlers(){this.drawOnClick1=it.bind(this),this.drawPreClick2=nt.bind(this),this.drawOnClick2=ot.bind(this),this.drawPreClick3=rt.bind(this),this.drawOnClick3=at.bind(this),this.drawDimension=ut.bind(this),this._onMoveDimension=bt.bind(this),this.setDimLines=gt.bind(this),this.updateDim=pt.bind(this),this.awaitSelection=F.bind(this),this.onHover=ue.bind(this),this.onPick=pe.bind(this),this.onDrag=me.bind(this),this.onRelease=ye.bind(this),this.onKeyPress=this.onKeyPress.bind(this),this.setHover=U.bind(this),this.clearSelection=be.bind(this)}setClean(){this.hasChanged=!1,this.idOnActivate=id,this.c_idOnActivate=this.c_id;const t=e=>{this.selected.length&&e.buttons&&(this.canvas.removeEventListener("pointermove",t),this.hasChanged=!0)};this.canvas.addEventListener("pointermove",t)}activate(){window.addEventListener("keydown",this.onKeyPress),this.canvas.addEventListener("pointerdown",this.onPick),this.canvas.addEventListener("pointermove",this.onHover),this.setDimLines(),this.obj3d.traverse((t=>t.layers.enable(2))),this.obj3d.visible=!0,this.scene.axes.matrix=this.obj3d.matrix,this.scene.axes.visible=!0,this.scene.activeSketch=this,window.sketcher=this,this.setClean()}deactivate(){window.removeEventListener("keydown",this.onKeyPress),this.canvas.removeEventListener("pointerdown",this.onPick),this.canvas.removeEventListener("pointermove",this.onHover),this.labelContainer.innerHTML="",this.obj3d.visible=!1,this.obj3d.traverse((t=>t.layers.disable(2))),this.scene.axes.visible=!1,this.scene.activeSketch=null,this.scene.newSketch&&(this.scene.newSketch=!1),this.clearSelection()}align(t,e,s){const i=L.subVectors(s,t).normalize(),n=Ee.elements;Pe.subVectors(e,t).normalize(),_e.crossVectors(Pe,i).normalize(),ke.crossVectors(_e,Pe),n[0]=Pe.x,n[4]=ke.x,n[8]=_e.x,n[1]=Pe.y,n[5]=ke.y,n[9]=_e.y,n[2]=Pe.z,n[6]=ke.z,n[10]=_e.z,this.obj3d.quaternion.setFromRotationMatrix(Ee);const o=this.obj3d.parent;Ee.extractRotation(o.matrixWorld),De.setFromRotationMatrix(Ee),this.obj3d.quaternion.premultiply(De.invert()),this.obj3d.updateMatrix(),this.obj3d.matrix.setPosition(t),this.plane.applyMatrix4(this.obj3d.matrix),this.obj3d.inverse=this.obj3d.matrix.clone().invert()}onKeyPress(t){this.command(t.key)}command(t){switch(t){case"Escape":ht.call(this),document.activeElement.blur();break;case"l":"line"==this.mode&&ht.call(this),this.mode="line",this.snap=!0,this.canvas.addEventListener("pointerdown",this.drawOnClick1,{once:!0});break;case"a":this.mode="arc",this.snap=!0,this.canvas.addEventListener("pointerdown",this.drawOnClick1,{once:!0});break;case"p":this.mode="point",this.snap=!0,this.canvas.addEventListener("pointerdown",(t=>{if("point"!==this.mode)return;const e=I();e.matrixAutoUpdate=!1,e.userData.constraints=[],e.geometry.attributes.position.set(this.getLocation(t).toArray()),e.layers.enable(2),this.obj3d.add(e),this.updatePointsBuffer(this.obj3d.children.length-1),this.scene.render()}));break;case"d":"dimension"!=this.mode&&(ht.call(this),this.mode="dimension",this.drawDimension());break;case"c":ht.call(this),ge.call(this);break;case"v":ht.call(this),fe.call(this,0);break;case"h":ht.call(this),fe.call(this,1);break;case"t":ht.call(this),ve.call(this);break;case"Delete":case"Backspace":this.deleteSelected();break;case"z":console.log("undo would be nice")}}deleteSelected(){this.selected.filter((t=>"dimension"==t.userData.type)).forEach((t=>this.constraints.has(t.name)&&this.deleteConstraints(t.name)));const t=this.selected.filter((t=>"line"==t.userData.type)).sort(((t,e)=>e.id-t.id)).map((t=>this.delete(t)));t.length&&this.updatePointsBuffer(t[t.length-1]),this.updateOtherBuffers(),this.selected=[],this.scene.render()}delete(t){if(!t)return;if("dimension"==t.userData.type)return void this.deleteConstraints(t.name);let e=this.linkedObjs.get(t.userData.l_id);if(!e)return;e=e[1];let s=this.objIdx.get(e[0])||this.updatePoint;for(let t=0;t<e.length;t++){const e=this.obj3d.children[s+t];e.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}));let i,n=[];for(let t of e.userData.constraints.slice())i=this.constraints.get(t),"points_coincident"==i[0]&&n.push(i[2][0]==e.name?i[2][1]:i[2][0]),this.deleteConstraints(t);for(let t=0;t<n.length-1;t++)ge.call(this,[this.obj3d.children[this.objIdx.get(n[t])],this.obj3d.children[this.objIdx.get(n[t+1])]]);e.userData.constraints=[]}return this.obj3d.children.splice(s,e.length),this.linkedObjs.delete(t.userData.l_id),s}deleteConstraints(t){for(let e of this.constraints.get(t)[2]){if(-1==e)continue;const s=this.obj3d.children[this.objIdx.get(e)];s&&s.userData.constraints.splice(s.userData.constraints.indexOf(t),1)}this.constraints.delete(t);for(let e=0;e<this.dimGroup.children.length;e++)if(this.dimGroup.children[e].name==t){this.dimGroup.children.splice(e,e+2).forEach((t=>{t.label&&t.label.remove(),t.geometry.dispose(),t.material.dispose()}));break}}updateOtherBuffers(){let t=0;for(let[e,s]of this.constraints)this.constraintsBuf.set([this.constraintNum[s[0]],s[1],...s[2].map((t=>this.objIdx.get(t)??0)),s[3],s[4]],8*t),t++;t=0;for(let[e,s]of this.linkedObjs)this.linksBuf.set([this.linkNum[s[0]],...s[1].map((t=>this.objIdx.get(t)??-1))],5*t),t++}updatePointsBuffer(t=0){for(let e=t;e<this.obj3d.children.length;e++){const t=this.obj3d.children[e];this.objIdx.set(t.name,e),"Points"==t.type&&this.ptsBuf.set(t.geometry.attributes.position.array,3*e)}}updateBoundingSpheres(){for(let t=this.geomStartIdx;t<this.obj3d.children.length;t++){this.obj3d.children[t].geometry.computeBoundingSphere()}for(let t=0;t<this.dimGroup.children.length;t++){this.dimGroup.children[t].geometry.computeBoundingSphere()}}getLocation(t){return z.setFromCamera(M.set((t.clientX-this.rect.left)/this.rect.width*2-1,-(t.clientY-this.rect.top)/this.rect.height*2+1),this.camera),z.ray.intersectPlane(this.plane,L).applyMatrix4(this.obj3d.inverse),L}getScreenXY(t){return L.set(...t).applyMatrix4(this.obj3d.matrix).project(this.camera)}solve(){const t=Module._malloc(this.ptsBuf.length*this.ptsBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.ptsBuf,t>>2);const e=Module._malloc(this.constraintsBuf.length*this.constraintsBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.constraintsBuf,e>>2);const s=Module._malloc(this.linksBuf.length*this.linksBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.linksBuf,s>>2),Module._solver(this.obj3d.children.length,t,this.constraints.size,e,this.linkedObjs.size,s,this.geomStartIdx);for(let e=this.geomStartIdx,s=(t>>2)+3*this.geomStartIdx;e<this.obj3d.children.length;e+=1,s+=3){const t=this.obj3d.children[e].geometry.attributes.position;isNaN(Module.HEAPF32[s])?(t.array[0]=Module.HEAPF32[s-6],t.array[1]=Module.HEAPF32[s-5],t.array[3]=Module.HEAPF32[s-3],t.array[4]=Module.HEAPF32[s-2]):(t.array[0]=Module.HEAPF32[s],t.array[1]=Module.HEAPF32[s+1]),t.needsUpdate=!0}Module._free(t),Module._free(s),Module._free(e);for(let[t,e]of this.linkedObjs){if("arc"!=e[0])continue;const[t,s,i,n]=e[1].map((t=>this.obj3d.children[this.objIdx.get(t)]));let o;o=et(t.geometry.attributes.position.array,s.geometry.attributes.position.array,i.geometry.attributes.position.array),n.geometry.attributes.position.set(o),n.needsUpdate=!0}this.setDimLines()}}const Ee=new j.y,De=new E._,Pe=new w.P,ke=new w.P,_e=new w.P;Object.assign(je.prototype,{linkNum:{line:0,arc:1},constraintNum:{points_coincident:0,pt_pt_distance:1,pt_plane_distance:2,pt_line_distance:3,pt_face_distance:4,pt_in_plane:5,pt_on_line:6,pt_on_face:7,equal_length_lines:8,length_ratio:9,eq_len_pt_line_d:10,eq_pt_ln_distances:11,equal_angle:12,equal_line_arc_len:13,symmetric:14,symmetric_horiz:15,symmetric_vert:16,symmetric_line:17,at_midpoint:18,horizontal:19,vertical:20,diameter:21,pt_on_circle:22,same_orientation:23,angle:24,parallel:25,perpendicular:26,arc_line_tangent:27,cubic_line_tangent:28,equal_radius:29,proj_pt_distance:30,where_dragged:31,curve_curve_tangent:32,length_difference:33,h_dist:34,v_dist:35},max_pts:1e3,max_links:1e3,max_constraints:1e3});var Se=s(3608),Me=s(7060),Le=s(461);function ze(t,e){let s=t.constraints,i=t.linkedObjs,n=t.obj3d.children,o=t.objIdx,r=new Set,a=[];function l(e){if(e.userData.construction)return;r.add(e);let h,c,d,u=i.get(e.userData.l_id);if("line"==u[0]?c=u[1][2]:"arc"==u[0]&&(c=u[1][3]),h=n[o.get(c)].geometry.attributes.position.array,u[1][0]==e.name){d=1;for(let t=0;t<h.length;t+=3)a.push(new D.F(h[t],h[t+1]))}else{d=0;for(let t=h.length-3;t>=0;t-=3)a.push(new D.F(h[t],h[t+1]))}let p=n[o.get(u[1][d])];n[t.geomStartIdx+1],function(e){for(let i of e.userData.constraints)if("points_coincident"==s.get(i)[0])for(let r of s.get(i)[2]){if(-1==r)continue;const s=n[o.get(r)];s!=e&&(s==n[t.geomStartIdx+1]||l(s))}}(p)}l(n[t.geomStartIdx+1]);const c=new Se.b(a),d={depth:e,bevelEnabled:!1},p=new Me.O(c,d),m=new Le.x({color:C.mesh,emissive:C.emissive}),y=new u.K(p,m);y.userData.type="mesh",y.userData.featureInfo=[t.obj3d.name,e],y.layers.enable(1);const b=new h.w(y.geometry,new v.U);return b.userData.type="point",b.visible=!1,b.layers.enable(1),y.add(b),y.matrixAutoUpdate=!1,y.matrix.multiply(t.obj3d.matrix),e<0&&(Ce(y.geometry),y.userData.inverted=!0),y}function Ce(t){const e=[0,0,0];for(let s=0;s<t.attributes.normal.array.length/9;s++)e[0]=t.attributes.normal.array[9*s],e[1]=t.attributes.normal.array[9*s+1],e[2]=t.attributes.normal.array[9*s+2],t.attributes.normal.array[9*s]=t.attributes.normal.array[9*s+6],t.attributes.normal.array[9*s+1]=t.attributes.normal.array[9*s+7],t.attributes.normal.array[9*s+2]=t.attributes.normal.array[9*s+8],t.attributes.normal.array[9*s+6]=e[0],t.attributes.normal.array[9*s+7]=e[1],t.attributes.normal.array[9*s+8]=e[2];for(let s=0;s<t.attributes.position.array.length/9;s++)e[0]=t.attributes.position.array[9*s],e[1]=t.attributes.position.array[9*s+1],e[2]=t.attributes.position.array[9*s+2],t.attributes.position.array[9*s]=t.attributes.position.array[9*s+6],t.attributes.position.array[9*s+1]=t.attributes.position.array[9*s+7],t.attributes.position.array[9*s+2]=t.attributes.position.array[9*s+8],t.attributes.position.array[9*s+6]=e[0],t.attributes.position.array[9*s+7]=e[1],t.attributes.position.array[9*s+8]=e[2];for(let s=0;s<t.attributes.uv.array.length/6;s++)e[0]=t.attributes.uv.array[6*s],e[1]=t.attributes.uv.array[6*s+1],t.attributes.uv.array[6*s]=t.attributes.uv.array[6*s+4],t.attributes.uv.array[6*s+1]=t.attributes.uv.array[6*s+5],t.attributes.uv.array[6*s+4]=e[0],t.attributes.uv.array[6*s+5]=e[1];t.attributes.normal.needsUpdate=!0,t.attributes.position.needsUpdate=!0,t.attributes.uv.needsUpdate=!0}var Ae=s(5353),Te=s(7289);class Be extends Ae.T{constructor(t=1){return super(),this.matrixAutoUpdate=!1,this.initialZoom=t,this.length=[5.5,10],this.headLength=2.5,this.headWidth=1.2,this.dirs=[[1,0,0],[0,1,0]],this.add(...this.dirs.map(((t,e)=>new Te.t(new w.P(...t),new w.P(0,0,0),this.length[e],13377306,this.headLength,this.headWidth)))),this}resize(t){const e=this.initialZoom/t;for(let t=0;t<this.children.length;t++)this.children[t].setLength(this.length[t]*e,this.headLength*e,this.headWidth*e)}}var Ie=s(7406),Oe=function(t,e){void 0===e&&console.warn('THREE.TrackballControls: The second parameter "domElement" is now mandatory.'),e===document&&console.error('THREE.TrackballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.');var s=this,i=-1,n=0,o=1,r=2,a=3,h=4;this.object=t,this.domElement=e,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=3,this.zoomSpeed=1.2,this.panSpeed=2,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!0,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.mouseButtons={LEFT:null,MIDDLE:m.RsA.PAN,RIGHT:m.RsA.ROTATE},this.target=new w.P;var l=1e-6,c=new w.P,d=1,u=i,p=i,y=new w.P,b=new D.F,g=new D.F,f=new w.P,v=0,x=new D.F,j=new D.F,P=0,k=0,_=new D.F,S=new D.F;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom;var M={type:"change"},L={type:"start"},z={type:"end"};this.handleResize=function(){var t=s.domElement.getBoundingClientRect(),e=s.domElement.ownerDocument.documentElement;s.screen.left=t.left+window.pageXOffset-e.clientLeft,s.screen.top=t.top+window.pageYOffset-e.clientTop,s.screen.width=t.width,s.screen.height=t.height};var C,A,T,B,I,O,F,U,R,q,H,N=(C=new D.F,function(t,e){return C.set((t-s.screen.left)/s.screen.width,(e-s.screen.top)/s.screen.height),C}),G=function(){var t=new D.F;return function(e,i){return t.set((e-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(s.screen.height+2*(s.screen.top-i))/s.screen.width),t}}();function Y(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(t.preventDefault(),t.stopPropagation(),u===i)switch(t.button){case 0:u=s.mouseButtons.LEFT;break;case 1:u=s.mouseButtons.MIDDLE;break;case 2:u=t.ctrlKey?s.mouseButtons.MIDDLE:s.mouseButtons.RIGHT;break;default:u=i}var e=p!==i?p:u;e!==n||s.noRotate?e!==o||s.noZoom?e!==r||s.noPan||(_.copy(N(t.pageX,t.pageY)),S.copy(_)):(x.copy(N(t.pageX,t.pageY)),j.copy(x)):(g.copy(G(t.pageX,t.pageY)),b.copy(g));s.domElement.ownerDocument.addEventListener("pointermove",V),s.domElement.ownerDocument.addEventListener("pointerup",W),s.dispatchEvent(L)}(t)}}function V(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1===s.enabled)return;t.preventDefault(),t.stopPropagation();var e=p!==i?p:u;e!==n||s.noRotate?e!==o||s.noZoom?e!==r||s.noPan||S.copy(N(t.pageX,t.pageY)):j.copy(N(t.pageX,t.pageY)):(b.copy(g),g.copy(G(t.pageX,t.pageY)));s.update()}(t)}}function W(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1===s.enabled)return;t.preventDefault(),t.stopPropagation(),u=i,s.domElement.ownerDocument.removeEventListener("pointermove",V),s.domElement.ownerDocument.removeEventListener("pointerup",W),s.dispatchEvent(z)}(t)}}function X(t){!1!==s.enabled&&(window.removeEventListener("keydown",X),p===i&&(t.keyCode!==s.keys[n]||s.noRotate?t.keyCode!==s.keys[o]||s.noZoom?t.keyCode!==s.keys[r]||s.noPan||(p=r):p=o:p=n))}function J(){!1!==s.enabled&&(p=i,window.addEventListener("keydown",X))}function Z(t){if(!1!==s.enabled&&!0!==s.noZoom){switch(t.preventDefault(),t.stopPropagation(),t.deltaMode){case 2:x.y-=.025*t.deltaY;break;case 1:x.y-=.01*t.deltaY;break;default:x.y-=25e-5*t.deltaY}s.update(),s.dispatchEvent(L),s.dispatchEvent(z)}}function $(t){if(!1!==s.enabled){switch(t.preventDefault(),t.touches.length){case 1:u=a,g.copy(G(t.touches[0].pageX,t.touches[0].pageY)),b.copy(g);break;default:u=h;var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;k=P=Math.sqrt(e*e+i*i);var n=(t.touches[0].pageX+t.touches[1].pageX)/2,o=(t.touches[0].pageY+t.touches[1].pageY)/2;_.copy(N(n,o)),S.copy(_)}s.dispatchEvent(L)}}function K(t){if(!1!==s.enabled){switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:b.copy(g),g.copy(G(t.touches[0].pageX,t.touches[0].pageY));break;default:var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;k=Math.sqrt(e*e+i*i);var n=(t.touches[0].pageX+t.touches[1].pageX)/2,o=(t.touches[0].pageY+t.touches[1].pageY)/2;S.copy(N(n,o))}s.update()}}function Q(t){if(!1!==s.enabled){switch(t.touches.length){case 0:u=i;break;case 1:u=a,g.copy(G(t.touches[0].pageX,t.touches[0].pageY)),b.copy(g)}s.dispatchEvent(z)}}function tt(t){!1!==s.enabled&&t.preventDefault()}this.rotateCamera=(T=new w.P,B=new E._,I=new w.P,O=new w.P,F=new w.P,U=new w.P,function(){U.set(g.x-b.x,g.y-b.y,0),(A=U.length())?(y.copy(s.object.position).sub(s.target),I.copy(y).normalize(),O.copy(s.object.up).normalize(),F.crossVectors(O,I).normalize(),O.setLength(g.y-b.y),F.setLength(g.x-b.x),U.copy(O.add(F)),T.crossVectors(U,y).normalize(),A*=s.rotateSpeed,B.setFromAxisAngle(T,A),y.applyQuaternion(B),s.object.up.applyQuaternion(B),f.copy(T),v=A):!s.staticMoving&&v&&(v*=Math.sqrt(1-s.dynamicDampingFactor),y.copy(s.object.position).sub(s.target),B.setFromAxisAngle(f,v),y.applyQuaternion(B),s.object.up.applyQuaternion(B)),b.copy(g)}),this.zoomCamera=function(){var t;u===h?(t=k/P,P=k,s.object.isPerspectiveCamera?y.multiplyScalar(t):s.object.isOrthographicCamera?(s.object.zoom*=t,s.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(1!==(t=1+(j.y-x.y)*s.zoomSpeed)&&t>0&&(s.object.isPerspectiveCamera?y.multiplyScalar(t):s.object.isOrthographicCamera?(s.object.zoom/=t,s.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),s.staticMoving?x.copy(j):x.y+=(j.y-x.y)*this.dynamicDampingFactor)},this.panCamera=(R=new D.F,q=new w.P,H=new w.P,function(){if(R.copy(S).sub(_),R.lengthSq()){if(s.object.isOrthographicCamera){var t=(s.object.right-s.object.left)/s.object.zoom/s.domElement.clientWidth,e=(s.object.top-s.object.bottom)/s.object.zoom/s.domElement.clientWidth;R.x*=t,R.y*=e}R.multiplyScalar(1*y.length()/577*s.domElement.clientWidth),H.copy(y).cross(s.object.up).setLength(R.x),H.add(q.copy(s.object.up).setLength(R.y)),s.object.position.add(H),s.target.add(H),s.staticMoving?_.copy(S):_.add(R.subVectors(S,_).multiplyScalar(s.dynamicDampingFactor))}}),this.checkDistances=function(){s.noZoom&&s.noPan||(y.lengthSq()>s.maxDistance*s.maxDistance&&(s.object.position.addVectors(s.target,y.setLength(s.maxDistance)),x.copy(j)),y.lengthSq()<s.minDistance*s.minDistance&&(s.object.position.addVectors(s.target,y.setLength(s.minDistance)),x.copy(j)))},this.update=function(){y.subVectors(s.object.position,s.target),s.noRotate||s.rotateCamera(),s.noZoom||s.zoomCamera(),s.noPan||s.panCamera(),s.object.position.addVectors(s.target,y),s.object.isPerspectiveCamera?(s.checkDistances(),s.object.lookAt(s.target),c.distanceToSquared(s.object.position)>l&&(s.dispatchEvent(M),c.copy(s.object.position))):s.object.isOrthographicCamera?(s.object.lookAt(s.target),(c.distanceToSquared(s.object.position)>l||d!==s.object.zoom)&&(s.dispatchEvent(M),c.copy(s.object.position),d=s.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")},this.reset=function(){u=i,p=i,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),y.subVectors(s.object.position,s.target),s.object.lookAt(s.target),s.dispatchEvent(M),c.copy(s.object.position),d=s.object.zoom},this.dispose=function(){s.domElement.removeEventListener("contextmenu",tt),s.domElement.removeEventListener("pointerdown",Y),s.domElement.removeEventListener("wheel",Z),s.domElement.removeEventListener("touchstart",$),s.domElement.removeEventListener("touchend",Q),s.domElement.removeEventListener("touchmove",K),s.domElement.ownerDocument.removeEventListener("pointermove",V),s.domElement.ownerDocument.removeEventListener("pointerup",W),window.removeEventListener("keydown",X),window.removeEventListener("keyup",J)},this.domElement.addEventListener("contextmenu",tt),this.domElement.addEventListener("pointerdown",Y),this.domElement.addEventListener("wheel",Z),this.domElement.addEventListener("touchstart",$),this.domElement.addEventListener("touchend",Q),this.domElement.addEventListener("touchmove",K),this.domElement.ownerDocument.addEventListener("pointermove",V),this.domElement.ownerDocument.addEventListener("pointerup",W),window.addEventListener("keydown",X),window.addEventListener("keyup",J),this.handleResize(),this.update()};(Oe.prototype=Object.create(Ie.p.prototype)).constructor=Oe;var Fe=s(1273);class Ue{constructor(){this.polygons=[]}clone(){let t=new Ue;return t.polygons=this.polygons.map((function(t){return t.clone()})),t}toPolygons(){return this.polygons}union(t){let e=new Ve(this.clone().polygons),s=new Ve(t.clone().polygons);return e.clipTo(s),s.clipTo(e),s.invert(),s.clipTo(e),s.invert(),e.build(s.allPolygons()),Ue.fromPolygons(e.allPolygons())}subtract(t){let e=new Ve(this.clone().polygons),s=new Ve(t.clone().polygons);return e.invert(),e.clipTo(s),s.clipTo(e),s.invert(),s.clipTo(e),s.invert(),e.build(s.allPolygons()),e.invert(),Ue.fromPolygons(e.allPolygons())}intersect(t){let e=new Ve(this.clone().polygons),s=new Ve(t.clone().polygons);return e.invert(),s.clipTo(e),s.invert(),e.clipTo(s),s.clipTo(e),e.build(s.allPolygons()),e.invert(),Ue.fromPolygons(e.allPolygons())}inverse(){let t=this.clone();return t.polygons.forEach((t=>t.flip())),t}}Ue.fromPolygons=function(t){let e=new Ue;return e.polygons=t,e};class Re{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new Re(this.x,this.y,this.z)}negate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}times(t){return this.x*=t,this.y*=t,this.z*=t,this}dividedBy(t){return this.x/=t,this.y/=t,this.z/=t,this}lerp(t,e){return this.add(qe.copy(t).sub(this).times(e))}unit(){return this.dividedBy(this.length())}length(){return Math.sqrt(this.x**2+this.y**2+this.z**2)}normalize(){return this.unit()}cross(t){let e=this;const s=e.x,i=e.y,n=e.z,o=t.x,r=t.y,a=t.z;return this.x=i*a-n*r,this.y=n*o-s*a,this.z=s*r-i*o,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}}let qe=new Re,He=new Re;class Ne{constructor(t,e,s,i){this.pos=(new Re).copy(t),this.normal=(new Re).copy(e),this.uv=(new Re).copy(s),this.uv.z=0,i&&(this.color=(new Re).copy(i))}clone(){return new Ne(this.pos,this.normal,this.uv,this.color)}flip(){this.normal.negate()}interpolate(t,e){return new Ne(this.pos.clone().lerp(t.pos,e),this.normal.clone().lerp(t.normal,e),this.uv.clone().lerp(t.uv,e),this.color&&t.color&&this.color.clone().lerp(t.color,e))}}class Ge{constructor(t,e){this.normal=t,this.w=e}clone(){return new Ge(this.normal.clone(),this.w)}flip(){this.normal.negate(),this.w=-this.w}splitPolygon(t,e,s,i,n){let o=0,r=[];for(let e=0;e<t.vertices.length;e++){let s=this.normal.dot(t.vertices[e].pos)-this.w,i=s<-Ge.EPSILON?2:s>Ge.EPSILON?1:0;o|=i,r.push(i)}switch(o){case 0:(this.normal.dot(t.plane.normal)>0?e:s).push(t);break;case 1:i.push(t);break;case 2:n.push(t);break;case 3:let o=[],a=[];for(let e=0;e<t.vertices.length;e++){let s=(e+1)%t.vertices.length,i=r[e],n=r[s],h=t.vertices[e],l=t.vertices[s];if(2!=i&&o.push(h),1!=i&&a.push(2!=i?h.clone():h),3==(i|n)){let t=(this.w-this.normal.dot(h.pos))/this.normal.dot(qe.copy(l.pos).sub(h.pos)),e=h.interpolate(l,t);o.push(e),a.push(e.clone())}}o.length>=3&&i.push(new Ye(o,t.shared)),a.length>=3&&n.push(new Ye(a,t.shared))}}}Ge.EPSILON=1e-5,Ge.fromPoints=function(t,e,s){let i=qe.copy(e).sub(t).cross(He.copy(s).sub(t)).normalize();return new Ge(i.clone(),i.dot(t))};class Ye{constructor(t,e){this.vertices=t,this.shared=e,this.plane=Ge.fromPoints(t[0].pos,t[1].pos,t[2].pos)}clone(){return new Ye(this.vertices.map((t=>t.clone())),this.shared)}flip(){this.vertices.reverse().map((t=>t.flip())),this.plane.flip()}}class Ve{constructor(t){this.plane=null,this.front=null,this.back=null,this.polygons=[],t&&this.build(t)}clone(){let t=new Ve;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map((t=>t.clone())),t}invert(){for(let t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();let t=this.front;this.front=this.back,this.back=t}clipPolygons(t){if(!this.plane)return t.slice();let e=[],s=[];for(let i=0;i<t.length;i++)this.plane.splitPolygon(t[i],e,s,e,s);return this.front&&(e=this.front.clipPolygons(e)),s=this.back?this.back.clipPolygons(s):[],e.concat(s)}clipTo(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)}allPolygons(){let t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t}build(t){if(!t.length)return;this.plane||(this.plane=t[0].plane.clone());let e=[],s=[];for(let i=0;i<t.length;i++)this.plane.splitPolygon(t[i],this.polygons,this.polygons,e,s);e.length&&(this.front||(this.front=new Ve),this.front.build(e)),s.length&&(this.back||(this.back=new Ve),this.back.build(s))}}Ue.fromJSON=function(t){return Ue.fromPolygons(t.polygons.map((t=>new Ye(t.vertices.map((t=>new Ne(t.pos,t.normal,t.uv))),t.shared))))},Ue.fromGeometry=function(t,e){if(!t.isBufferGeometry)return void console.error("Unsupported CSG input type:"+t.type);let s,i=[],n=t.attributes.position,o=t.attributes.normal,r=t.attributes.uv,a=t.attributes.color;if(t.index)s=t.index.array;else{s=new Array(n.array.length/n.itemSize|0);for(let t=0;t<s.length;t++)s[t]=t}let h=s.length/3|0;i=new Array(h);for(let t=0,h=0,l=s.length;t<l;t+=3,h++){let l=new Array(3);for(let e=0;e<3;e++){let i=s[t+e],h=3*i,c=2*i,d=n.array[h],u=n.array[h+1],p=n.array[h+2],m=o.array[h],y=o.array[h+1],b=o.array[h+2],g=r.array[c],f=r.array[c+1];l[e]=new Ne({x:d,y:u,z:p},{x:m,y,z:b},{x:g,y:f,z:0},a&&{x:a.array[c],y:a.array[c+1],z:a.array[c+2]})}i[h]=new Ye(l,e)}return Ue.fromPolygons(i)};let We=new w.P,Xe=new Fe.V;Ue.fromMesh=function(t,e){let s=Ue.fromGeometry(t.geometry,e);Xe.getNormalMatrix(t.matrix);for(let e=0;e<s.polygons.length;e++){let i=s.polygons[e];for(let e=0;e<i.vertices.length;e++){let s=i.vertices[e];s.pos.copy(We.copy(s.pos).applyMatrix4(t.matrix)),s.normal.copy(We.copy(s.normal).applyMatrix3(Xe))}}return s};let Je=t=>({top:0,array:new Float32Array(t),write:function(t){this.array[this.top++]=t.x,this.array[this.top++]=t.y,this.array[this.top++]=t.z}}),Ze=t=>({top:0,array:new Float32Array(t),write:function(t){this.array[this.top++]=t.x,this.array[this.top++]=t.y}});Ue.toMesh=function(t,e,s){let i,n,o=t.polygons;{let t=0;o.forEach((e=>t+=e.vertices.length-2)),i=new l.u;let e,s=Je(3*t*3),r=Je(3*t*3),a=Ze(2*t*3),h=[];if(o.forEach((i=>{let n=i.vertices,o=n.length;void 0!==i.shared&&(h[i.shared]||(h[i.shared]=[])),o&&void 0!==n[0].color&&(e||(e=Je(3*t*3)));for(let t=3;t<=o;t++)void 0!==i.shared&&h[i.shared].push(s.top/3,s.top/3+1,s.top/3+2),s.write(n[0].pos),s.write(n[t-2].pos),s.write(n[t-1].pos),r.write(n[0].normal),r.write(n[t-2].normal),r.write(n[t-1].normal),a.write(n[0].uv),a.write(n[t-2].uv),a.write(n[t-1].uv),e&&(e.write(n[0].color)||e.write(n[t-2].color)||e.write(n[t-1].color))})),i.setAttribute("position",new c.Tl(s.array,3)),i.setAttribute("normal",new c.Tl(r.array,3)),i.setAttribute("uv",new c.Tl(a.array,2)),e&&i.setAttribute("color",new c.Tl(e.array,3)),h.length){let t=[],e=0;for(let s=0;s<h.length;s++)i.addGroup(e,h[s].length,s),e+=h[s].length,t=t.concat(h[s]);i.setIndex(t)}n=i}let r=(new j.y).copy(e).invert();i.applyMatrix4(r),i.computeBoundingSphere(),i.computeBoundingBox();let a=new u.K(i,s);return a.matrix.copy(e),a.matrix.decompose(a.position,a.quaternion,a.scale),a.rotation.setFromQuaternion(a.quaternion),a.updateMatrixWorld(),a.castShadow=a.receiveShadow=!0,a};const $e=Ue;var Ke=function(){};let Qe,ts,es,ss,is,ns,os;Ke.prototype={constructor:Ke,parse:function(t,e){void 0===e&&(e={});var s,i=void 0!==e.binary&&e.binary,n=[],o=0;t.traverse((function(t){if(t.isMesh){var e=t.geometry;if(!0!==e.isBufferGeometry)throw new Error("THREE.STLExporter: Geometry is not of type THREE.BufferGeometry.");var s=e.index,i=e.getAttribute("position");o+=null!==s?s.count/3:i.count/3,n.push({object3d:t,geometry:e})}}));var r=80;if(!0===i){var a=new ArrayBuffer(2*o+3*o*4*4+80+4);(s=new DataView(a)).setUint32(r,o,!0),r+=4}else s="",s+="solid exported\n";for(var h=new w.P,l=new w.P,c=new w.P,d=new w.P,u=new w.P,p=new w.P,m=0,y=n.length;m<y;m++){var b=n[m].object3d,g=n[m].geometry,f=g.index,v=g.getAttribute("position");if(null!==f)for(var x=0;x<f.count;x+=3){j(f.getX(x+0),f.getX(x+1),f.getX(x+2),v,b)}else for(x=0;x<v.count;x+=3){j(x+0,x+1,x+2,v,b)}}return!1===i&&(s+="endsolid exported\n"),s;function j(t,e,n,o,a){h.fromBufferAttribute(o,t),l.fromBufferAttribute(o,e),c.fromBufferAttribute(o,n),!0===a.isSkinnedMesh&&(a.boneTransform(t,h),a.boneTransform(e,l),a.boneTransform(n,c)),h.applyMatrix4(a.matrixWorld),l.applyMatrix4(a.matrixWorld),c.applyMatrix4(a.matrixWorld),function(t,e,n){d.subVectors(n,e),u.subVectors(t,e),d.cross(u).normalize(),p.copy(d).normalize(),!0===i?(s.setFloat32(r,p.x,!0),r+=4,s.setFloat32(r,p.y,!0),r+=4,s.setFloat32(r,p.z,!0),r+=4):(s+="\tfacet normal "+p.x+" "+p.y+" "+p.z+"\n",s+="\t\touter loop\n")}(h,l,c),E(h),E(l),E(c),!0===i?(s.setUint16(r,0,!0),r+=2):(s+="\t\tendloop\n",s+="\tendfacet\n")}function E(t){!0===i?(s.setFloat32(r,t.x,!0),r+=4,s.setFloat32(r,t.y,!0),r+=4,s.setFloat32(r,t.z,!0),r+=4):s+="\t\t\tvertex "+t.x+" "+t.y+" "+t.z+"\n"}}},window.loader=new i.G,window.STLexp=new Ke,window.id=0;class rs{constructor(t){this.sid=1,this.mid=1,this.canvas=document.querySelector("#c"),this.rect=this.canvas.getBoundingClientRect().toJSON(),this.renderer=new n.C({canvas:this.canvas}),this.store=t;this.camera=new o.i(-1,1,1,-1,-1,1e3),this.camera.zoom=.008;const e=30*Math.PI/180;this.camera.position.set(500*Math.sin(e),500*Math.tan(30*Math.PI/180),500*Math.cos(e)),this.camera.layers.enable(3),this.controls=new Oe(this.camera,this.canvas),this.controls.target.set(0,0,0),this.controls.update(),this.obj3d=new r.x;const s=new a.Z;s.name="helpers",this.obj3d.add(s);for(let t=0;t<4;t++){const t=new h.w((new l.u).setAttribute("position",new c.a$(3,3)),R.clone());t.matrixAutoUpdate=!1,t.visible=!1,t.renderOrder=1,t.userData.type="selpoint",s.add(t)}this.selpoints=this.obj3d.children[0].children,this.fptIdx=0,this.fptObj={};const i=new d._(50,50),v=new u.K(i,new p.v({color:C.plane,opacity:.02,side:m.ehD,transparent:!0,depthWrite:!1,toneMapped:!1}));v.add(new y.e(new b.T(i),new g.n({color:C.planeBorder}))),v.userData.type="plane",v.layers.enable(1),v.children[0].layers.disable(1);const w=v.clone().rotateY(Math.PI/2),x=v.clone().rotateX(-Math.PI/2);s.add(v),[x,w].forEach((t=>{t.traverse((t=>t.material=t.material.clone())),s.add(t)})),this.axes=new Be(this.camera.zoom),this.axes.visible=!1,s.add(this.axes);const j=500,E=new f.c(C.lighting,.7);E.position.set(j,j,j),s.add(E);const D=new f.c(C.lighting,.7);D.position.set(-500,-500,-500),s.add(D),this.render=as.bind(this),this.addSketch=hs.bind(this),this.extrude=this.extrude.bind(this),this.onHover=ue.bind(this),this.onPick=pe.bind(this),this.clearSelection=be.bind(this),this.setHover=U.bind(this),this.awaitSelection=F.bind(this),this.obj3d.addEventListener("change",this.render),this.controls.addEventListener("change",this.render),this.controls.addEventListener("start",this.render),window.addEventListener("resize",this.render),this.hovered=[],this.selected=[],this.activeSketch=null,this.render()}resizeCanvas(t){const e=t.domElement,s=e.clientWidth,i=e.clientHeight,n=e.width!==s||e.height!==i;return n&&t.setSize(s,i,!1),n}clearScene(){const t=this.obj3d.children.splice(1);for(let e=0;e<t.length;e++)t[e].traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))}newPart(){this.clearScene(),window.id=0,this.sid=1,this.mid=1}loadState(t){this.clearScene();const[e,s,i,n]=JSON.parse(t);window.id=e,this.sid=s,this.mid=i;const o=n.byId;for(let t in o)"s"==t[0]?(o[t].obj3d=loader.parse(o[t].obj3d),this.obj3d.add(o[t].obj3d),o[t]=new je(this,o[t]),o[t].obj3d.addEventListener("change",this.render)):"e"==t[0]?(o[t]=loader.parse(n.byId[t]),o[t].userData.inverted&&Ce(o[t].geometry),this.obj3d.add(o[t])):(o[t]=loader.parse(n.byId[t]),this.obj3d.add(o[t]));return n}loadSketch(t){let e=JSON.parse(t);return e.obj3d=loader.parse(e.obj3d),e=new je(this,e),e.obj3d.addEventListener("change",this.render),e}extrude(t,e){const s=ze(t,e);return s.name="e"+this.mid++,this.obj3d.add(s),s}boolOp(t,e,s){let i,n,o=$e.fromMesh(t),r=$e.fromMesh(e);switch(t.visible=!1,e.visible=!1,t.traverse((t=>t.layers.disable(1))),e.traverse((t=>t.layers.disable(1))),s){case"s":i=o.subtract(r),n="-";break;case"u":i=o.union(r),n="∪";break;case"i":i=o.intersect(r),n="∩"}let a=$e.toMesh(i,t.matrix,t.material);a.userData.type="mesh",a.userData.featureInfo=[t.name,e.name,s],a.name=`(${t.name} ${n} ${e.name})`,a.layers.enable(1);const l=new h.w(a.geometry,new v.U);return l.visible=!1,l.userData.type="point",l.layers.enable(1),a.add(l),a}refreshNode(t,{byId:e,tree:s}){let i,n=[t],o=0;for(;o<n.length;){if(i=n[o++],e[i].userData){const t=e[i].userData.featureInfo;let s;2==t.length?s=ze(e[t[0]],t[1]):3==t.length&&(s=this.boolOp(e[t[0]],e[t[1]],t[2])),e[i].geometry.copy(s.geometry),e[i].geometry.parameters=s.geometry.parameters}for(let t in s[i])n.push(t)}}}function as(){if(this.resizeCanvas(this.renderer)){const t=this.renderer.domElement;this.camera.left=-t.clientWidth/t.clientHeight,this.camera.right=t.clientWidth/t.clientHeight,this.camera.updateProjectionMatrix(),this.controls.handleResize(),Object.assign(this.rect,this.canvas.getBoundingClientRect().toJSON())}if(this.axes&&this.axes.resize(this.camera.zoom),this.renderer.render(this.obj3d,this.camera),this.activeSketch)for(ns=this.activeSketch.dimGroup.children,os=this.activeSketch.obj3d.matrix,Qe=1;Qe<ns.length;Qe+=2)ss=ns[Qe],is=L.set(...ss.geometry.attributes.position.array).applyMatrix4(os).project(this.camera),ts=(.5*is.x+.5)*this.canvas.clientWidth+10+this.rect.left,es=(-.5*is.y+.5)*this.canvas.clientHeight+this.rect.top,ss.label.style.transform=`translate(0%, -50%) translate(${ts}px,${es}px)`}function hs(){let t;if(3==this.selected.length&&this.selected.every((t=>"selpoint"==t.userData.type)))t=new je(this),this.obj3d.add(t.obj3d),t.align(...this.selected.map((t=>new w.P(...t.geometry.attributes.position.array).applyMatrix4(t.matrixWorld))));else{if(!this.selected.length||"plane"!=this.selected[0].userData.type)return;t=new je(this),t.obj3d.matrix=this.selected[0].matrix,t.plane.applyMatrix4(t.obj3d.matrix),t.obj3d.inverse=t.obj3d.matrix.clone().invert(),this.obj3d.add(t.obj3d)}return this.newSketch=!0,this.clearSelection(),t.obj3d.addEventListener("change",this.render),t}}}]);