(self.webpackChunk=self.webpackChunk||[]).push([[48],{48:(t,e,s)=>{"use strict";s.r(e),s.d(e,{Scene:()=>Ee});var i=s(5879),n=s(1401),o=s(3131),r=s(7365),a=s(2010),h=s(2306),l=s(9046),c=s(140),d=s(4078),p=s(6454),u=s(6173),m=s(1661),y=s(5920),b=s(1516),g=s(5785),f=s(8490),v=s(6679),w=s(6881),x=s(1158),j=s(9203),E=s(7092),D=s(3489),k=s(1691),P=s(1138);const _=new g.n({linewidth:1,color:D.$_.dimension}),S=new v.U({color:D.$_.dimension,size:4});let M;async function L(){let t,e,s,i=await this.awaitSelection({point:2},{point:1,line:1},{line:2});if(null==i)return;if(i.every((t=>"line"==t.userData.type)))t=new y.e((new l.u).setAttribute("position",new c.a$(Array(2*(nt+2)*3).fill(-.001),3)),_.clone()),M=_t(i),e=["angle",M,[-1,-1,i[0].name,i[1].name],0],s="a";else{let n;if(t=new y.e((new l.u).setAttribute("position",new c.a$(Array(24).fill(-.001),3)),_.clone()),i.every((t=>"point"==t.userData.type))){M=0;for(let t=0;t<3;t++)M+=(i[0].geometry.attributes.position.array[t]-i[1].geometry.attributes.position.array[t])**2;M=Math.sqrt(M),e=["pt_pt_distance",M,[i[0].name,i[1].name,-1,-1]]}else{n="point"==i[0].userData.type?[0,1]:[1,0];const t=i[n[0]].geometry.attributes.position.array,s=i[n[1]].geometry.attributes.position.array;B.set(s[0],s[1]),G.set(s[3],s[4]),T.set(t[0],t[1]),$=G.clone().sub(B).normalize(),H=T.clone().sub(B),q=$.multiplyScalar(H.dot($)),Q=H.clone().sub(q),M=Math.sign(Q.y)*Math.sqrt(Q.x**2+Q.y**2),e=["pt_line_distance",M,[i[n[0]].name,-1,i[n[1]].name,-1]]}s="d"}const n=new h.w((new l.u).setAttribute("position",new c.a$(3,3)),S.clone());t.userData.ids=i.map((t=>t.name)),t.userData.type="dimension",t.userData.dimType=s,n.userData.type="dimension",n.userData.dimType=s,t.layers.enable(2),n.layers.enable(2),this.dimGroup.add(t).add(n);const o=this._onMoveDimension(n,t,!0);let r,a;n.label=document.createElement("div"),n.label.textContent=M.toFixed(3),n.label.contentEditable=!0,this.labelContainer.append(n.label);let d=await new Promise((t=>{r=()=>{"a"==n.userData.dimType?n.userData.offset=ot[5].toArray():n.userData.offset=N.toArray(),t(!0)},a=e=>"Escape"==e.key&&t(!1),this.canvas.addEventListener("pointermove",o),this.canvas.addEventListener("pointerdown",r),window.addEventListener("keydown",a)}));this.canvas.removeEventListener("pointermove",o),this.canvas.removeEventListener("pointerdown",r),window.removeEventListener("keydown",a),n.geometry.computeBoundingSphere(),t.geometry.computeBoundingSphere(),d?("h"==t.userData.dimType?(e[0]="h_dist",e[1]=G.x-B.x):"v"==t.userData.dimType&&(e[0]="v_dist",e[1]=G.y-B.y),this.constraints.set(++this.c_id,e),i[0].userData.constraints.push(this.c_id),i[1].userData.constraints.push(this.c_id),this.updateOtherBuffers(),t.name=this.c_id,n.name=this.c_id,n.label.addEventListener("focus",this.updateDim(this.c_id))):(this.dimGroup.children.splice(this.dimGroup.children.length-2,2).forEach((t=>{t.geometry.dispose(),t.material.dispose()})),this.labelContainer.removeChild(this.labelContainer.lastChild),this.scene.render()),"dimension"==this.scene.mode&&this.drawDimension()}function z(t){return e=>{let s=e.target.textContent;document.addEventListener("keydown",(i=>{if("Enter"==i.key){i.preventDefault();const n=this.constraints.get(t);n[1]=parseFloat(e.target.textContent),s=n[1],this.constraints.set(t,n),this.updateOtherBuffers(),this.solve(),this.scene.render(),e.target.blur(),this.updateBoundingSpheres()}else"Escape"==i.key&&(e.target.textContent=s,getSelection().empty(),e.target.blur())}))}}const T=new P.F;let A;function I(t,e,s){A=e.userData.ids;let i,n,o=this.obj3d.children[this.objIdx.get(A[0])].geometry.attributes.position.array,r=this.obj3d.children[this.objIdx.get(A[1])].geometry.attributes.position.array;return n="a"==e.userData.dimType?jt:it,a=>{i=this.getLocation(a),T.set(i.x,i.y),n(e,t,o,r,null,s),this.scene.render()}}function C(){const t=0==this.labelContainer.childElementCount,e=this.dimGroup.children;let s,i;for(let n=0;n<e.length;n+=2){t&&(s=e[n+1],i=this.constraints.get(s.name)[1],s.label=document.createElement("div"),s.label.textContent=i.toFixed(3),s.label.contentEditable=!0,this.labelContainer.append(s.label),s.label.addEventListener("focus",this.updateDim(this.c_id))),A=e[n].userData.ids;let o,r=this.obj3d.children[this.objIdx.get(A[0])].geometry.attributes.position.array,a=this.obj3d.children[this.objIdx.get(A[1])].geometry.attributes.position.array;o="a"==e[n].userData.dimType?jt:it,o(e[n],e[n+1],r,a,e[n+1].userData.offset)}}const B=new P.F;let F;const O=new P.F,G=new P.F;let H,R,N,q,W,Y,U,X,V,Z,K,$,J,Q,tt,et,st;function it(t,e,s,i,n,o){const r=t.geometry.attributes.position,a=e.geometry.attributes.position;n&&(s.length<i.length?T.set(s[0]+n[0],s[1]+n[1]):T.set(i[0]+n[0],i[1]+n[1]));let h=null;if(s.length==i.length)switch(B.set(s[0],s[1]),G.set(i[0],i[1]),o&&((T.x-B.x)*(T.x-G.x)>0&&(T.y-B.y)*(T.y-G.y)<0?(t.userData.dimType="v",e.userData.dimType="v",e.label.textContent=(G.y-B.y).toFixed(3)):(T.x-B.x)*(T.x-G.x)<0&&(T.y-B.y)*(T.y-G.y)>0?(t.userData.dimType="h",e.userData.dimType="h",e.label.textContent=(G.x-B.x).toFixed(3)):(t.userData.dimType="d",e.userData.dimType="d",e.label.textContent=M.toFixed(3))),t.userData.dimType){case"v":h=[s[0]+1,s[1]];break;case"h":h=[s[0],s[1]+1];break;default:$=G.clone().sub(B).normalize(),N=T.clone().sub(G),q=$.multiplyScalar(N.dot($)),Q=N.clone().sub(q),U=B.clone().add(Q),V=U.toArray(),X=G.clone().add(Q),Z=X.toArray(),K=T.toArray(),tt=U.distanceToSquared(T),et=X.distanceToSquared(T),st=U.distanceToSquared(X),r.array.set(B.toArray(),0)}(s.length!=i.length||h)&&(h?(B.set(s[0],s[1]),O.set(...h),G.set(i[0],i[1])):s.length>i.length?(B.set(s[0],s[1]),O.set(s[3],s[4]),G.set(i[0],i[1])):(B.set(i[0],i[1]),O.set(i[3],i[4]),G.set(s[0],s[1])),J=O.clone().sub(B),F=B.clone().addScaledVector(J,.5),J.normalize(),H=G.clone().sub(F),q=J.multiplyScalar(H.dot(J)),$=H.clone().sub(q),st=$.lengthSq(),$.normalize(),R=T.clone().sub(F),W=$.clone().multiplyScalar(R.dot($)),N=T.clone().sub(G),Y=$.clone().multiplyScalar(N.dot($)),V=T.clone().sub(W).toArray(),Z=T.clone().sub(Y).toArray(),K=T.toArray(),tt=W.lengthSq(),et=Y.lengthSq(),r.array.set(F.toArray(),0)),r.array.set(V,3),r.array.set(V,6),r.array.set(Z,9),r.array.set(Z,12),r.array.set(G.toArray(),15),st>=tt&&st>=et?r.array.set(K,18):tt>et?r.array.set(Z,18):r.array.set(V,18),r.array.set(K,21),r.needsUpdate=!0,a.array.set(K),a.needsUpdate=!0}const nt=12,ot=Array(6);for(let t=0;t<ot.length;t++)ot[t]=new P.F;const rt=Array(3),at=new P.F;let ht,lt,ct,dt,pt,ut,mt,yt,bt,gt,ft,vt,wt,xt;function jt(t,e,s,i,n){const o=t.geometry.attributes.position,r=e.geometry.attributes.position;for(lt=0;lt<4;)ht=0==lt?s:i,ot[lt++].set(ht[0],ht[1]),ot[lt++].set(ht[3]-ht[0],ht[4]-ht[1]);for(pt=ot[3].cross(ot[1]),dt=0===pt?.5:at.subVectors(ot[0],ot[2]).cross(ot[3])/pt,ut=ot[4].addVectors(ot[0],ot[1].clone().multiplyScalar(dt)),n&&T.set(ut.x+n[0],ut.y+n[1]),ot[5].subVectors(T,ut),mt=ot[5].length(),ct=1,lt=0;ct<ot.length;ct+=2,lt++)rt[lt]=Math.atan2(ot[ct].y,ot[ct].x);yt=Pt(rt[1]-rt[0]),bt=Pt(rt[2]-(rt[0]+yt/2)),gt=Math.abs(bt)<Math.PI/2?0:Math.PI,ft=Pt(rt[2]-(rt[0]+gt)),vt=Pt(rt[2]-(rt[0]+yt+gt)),yt*ft<0?(wt=rt[0]+ft+gt,xt=yt-ft):yt*vt>0?(wt=rt[0]+gt,xt=yt+vt):(wt=rt[0]+gt,xt=yt),ct=0,o.array[ct++]=ut.x+mt*Math.cos(wt),o.array[ct++]=ut.y+mt*Math.sin(wt),ct++;let a=wt+1/nt*xt;for(o.array[ct++]=ut.x+mt*Math.cos(a),o.array[ct++]=ut.y+mt*Math.sin(a),ct++,lt=2;lt<=nt;lt++)o.array[ct++]=o.array[ct-4],o.array[ct++]=o.array[ct-4],ct++,a=wt+lt/nt*xt,o.array[ct++]=ut.x+mt*Math.cos(a),o.array[ct++]=ut.y+mt*Math.sin(a),ct++;for(lt=0;lt<2;lt++)o.array[ct++]=ot[2*lt].x,o.array[ct++]=ot[2*lt].y,ct++,o.array[ct++]=ut.x+mt*Math.cos(rt[lt]+gt),o.array[ct++]=ut.y+mt*Math.sin(rt[lt]+gt),ct++;o.needsUpdate=!0,r.array.set(T.toArray()),r.needsUpdate=!0}const Et=2*Math.PI,Dt=2*-Math.PI,kt=-Math.PI;function Pt(t){return t>Math.PI?t=Dt+t:t<kt&&(t=Et+t),t}const _t=t=>{for(let e=0;e<2;e++){const s=t[e].geometry.attributes.position.array;ot[2*e].set(...s.slice(0,2)),ot[2*e+1].set(s[3]-s[0],s[4]-s[1])}const e=Math.atan2(ot[1].y,ot[1].x),s=Math.atan2(ot[3].y,ot[3].x);let i=Math.abs(s-e);return i>Math.PI&&(i=2*Math.PI-i),i/Math.PI*180};let St,Mt;function Lt(t){if(t.buttons)return;let e;D.KW.setFromCamera(new P.F((t.clientX-this.rect.left)/this.rect.width*2-1,-(t.clientY-this.rect.top)/this.rect.height*2+1),this.camera),"sketch"!=this.obj3d.userData.type?(D.KW.layers.set(1),e=D.KW.intersectObjects(this.obj3d.children,!0)):(D.KW.layers.set(2),e=D.KW.intersectObjects([...this.dimGroup.children,...this.obj3d.children]));let s=[];const i=1e-4;if(e.length){let t=1/0;for(let n=0;n<e.length;n++)if(e[n].distanceToRay)if(e[n].distanceToRay<t-i){if(s=[n],"sketch"!=this.obj3d.userData.type)break;t=e[n].distanceToRay}else e[n].distanceToRay<t+i&&s.push(n);s.length||this.disableLineHover||s.push(0)}const n=this.selected||this.scene.selected;if(s.length){if(!this.hovered.length||"number"==typeof this.hovered[0]&&this.hovered[0]!=e[s[0]].index||"object"==typeof this.hovered[0]&&this.hovered[0]!=e[s[0]].object){for(let t=0;t<this.hovered.length;t++){const e=this.hovered[t];"object"!=typeof e||n.includes(e)||(0,D.GZ)(e,0)}this.hovered=[];for(let t=0;t<s.length;t++){let i=e[s[t]].object;(0,D.GZ)(i,1,!1),"sketch"!=this.obj3d.userData.type&&("point"==i.userData.type?(St=i.geometry.attributes.position.array.slice(3*e[s[t]].index,3*e[s[t]].index+3),this.selpoints[0].geometry.attributes.position.array.set(St),this.selpoints[0].matrix=i.parent.matrix,this.selpoints[0].geometry.attributes.position.needsUpdate=!0,this.selpoints[0].visible=!0,i=e[s[t]].index,this.selpoints[0].idx=i):this.selpoints[0].visible=!1),this.hovered.push(i)}this.obj3d.dispatchEvent({type:"change"})}}else if(this.hovered.length){for(let t=0;t<this.hovered.length;t++){const e=this.hovered[t];"number"==typeof e?this.selpoints[0].visible=!1:n.includes(e)||(0,D.GZ)(e,0)}this.hovered=[],this.obj3d.dispatchEvent({type:"change"})}}function zt(t){if(this.scene&&["line","arc"].includes(this.scene.mode)||1!=t.buttons)return;const e=this.store||this.scene.store,s=this.selected||this.scene.selected;if(this.hovered.length){let t=this.hovered[this.hovered.length-1];if("object"!=typeof t){const e=this.selpoints[this.fptIdx%3+1],s=this.selpoints[0];e.geometry.attributes.position.array.set(s.geometry.attributes.position.array),e.matrix=s.matrix,e.geometry.attributes.position.needsUpdate=!0,e.visible=!0,t=e,this.fptIdx++}e.dispatch({type:"on-pick",obj:t});const i=s.indexOf(t);if("selpoint"!=t.userData.type&&(-1==i?this.setHover(t,1):this.setHover(s[i],0)),this.obj3d.dispatchEvent({type:"change"}),"sketch"==this.obj3d.userData.type)switch(t.userData.type){case"dimension":const t=this.dimGroup.children.indexOf(this.hovered[0]);t%2&&(this.onDragDim=this._onMoveDimension(this.dimGroup.children[t],this.dimGroup.children[t-1]),this.canvas.addEventListener("pointermove",this.onDragDim),this.canvas.addEventListener("pointerup",(()=>{var e;"a"==(e=this.dimGroup.children[t]).userData.dimType?e.userData.offset=ot[5].toArray():e.userData.offset=N.toArray(),this.onRelease()}))),Mt=this.dimGroup.children[t].label,Mt.style.zIndex=-1;break;case"point":this.canvas.addEventListener("pointermove",this.onDrag),this.canvas.addEventListener("pointerup",this.onRelease)}}else{const t=e.getState().treeEntries.visible;for(let e,i=0;i<s.length;i++)e=s[i],"selpoint"==e.userData.type?e.visible=!1:(0,D.GZ)(e,0),"sketch"!=e.userData.type||t[e.name]||(e.visible=!1);e.dispatch({type:"clear-selection"}),this.obj3d.dispatchEvent({type:"change"})}}function Tt(t){for(let e=0;e<this.hovered.length;e++){const s=this.hovered[e];this.ptsBuf.set(this.getLocation(t).toArray(),3*this.objIdx.get(s.name))}this.solve(),this.scene.render()}function At(t){this.canvas.removeEventListener("pointermove",this.onDrag),this.canvas.removeEventListener("pointermove",this.onDragDim),this.canvas.removeEventListener("pointerup",this.onRelease),this.updateBoundingSpheres(),Mt&&(Mt.style.zIndex=0)}function It(){const t=this.selected||this.scene.selected;for(let e,s=0;s<t.length;s++)e=t[s],"selpoint"==e.userData.type?e.visible=!1:(0,D.GZ)(e,0);store.dispatch({type:"clear-selection"});for(let t=0;t<this.hovered.length;t++){const e=this.hovered[t];(0,D.GZ)(e,0)}}async function Ct(t){let e;if(void 0===t){if(e=await this.awaitSelection({point:2},{point:1,line:1}),null==e)return}else e=t;if(e.every((t=>"point"==t.userData.type)))this.constraints.set(++this.c_id,["points_coincident",-1,[e[0].name,e[1].name,-1,-1]]);else{const t="point"==e[0].userData.type?[0,1]:[1,0];this.constraints.set(++this.c_id,[void 0!==e[t[1]].userData.ccw?"pt_on_circle":"pt_on_line",-1,[e[t[0]].name,-1,e[t[1]].name,-1]])}e[1].userData.constraints.push(this.c_id),e[0].userData.constraints.push(this.c_id),this.updateOtherBuffers(),this.solve(),this.updateBoundingSpheres(),this.clearSelection(),this.scene.render()}var Bt=s(6791);function Ft(t,e){return e instanceof Map?{dataType:"Map",value:Array.from(e.entries())}:e}function Ot(t,e){return"object"==typeof e&&null!==e&&"Map"===e.dataType?new Map(e.value):e}class Gt{constructor(t,e){if(this.ptsBuf=new Float32Array(3*this.max_pts).fill(NaN),this.linksBuf=new Float32Array(5*this.max_links).fill(NaN),this.constraintsBuf=new Float32Array(8*this.max_constraints).fill(NaN),this.plane=new x.J(new w.P(0,0,1),0),this.labelContainer=document.getElementById("labels"),void 0===e){this.obj3d=new a.Z,this.obj3d.name="s"+t.sid++,this.obj3d.userData.type="sketch",this.obj3d.matrixAutoUpdate=!1,this.objIdx=new Map,this.linkedObjs=new Map,this.l_id=0,this.constraints=new Map,this.c_id=1,this.dimGroup=new a.Z,this.dimGroup.name="dimensions",this.obj3d.add(this.dimGroup),this.geomStartIdx=this.obj3d.children.length,this.obj3d.userData.geomStartIdx=this.geomStartIdx,this.labels=[];const e=(0,D.J1)();e.matrixAutoUpdate=!1,e.userData.constraints=[],this.obj3d.add(e),this.updatePointsBuffer()}else this.obj3d=e.obj3d,this.obj3d.inverse=e.obj3d.matrix.clone().invert(),this.objIdx=JSON.parse(e.objIdx,Ot),this.linkedObjs=JSON.parse(e.linkedObjs,Ot),this.l_id=e.l_id,this.constraints=JSON.parse(e.constraints,Ot),this.c_id=e.c_id,this.geomStartIdx=this.obj3d.userData.geomStartIdx,this.dimGroup=this.obj3d.children[this.geomStartIdx-1],this.updatePointsBuffer(),this.updateOtherBuffers(),this.plane.applyMatrix4(this.obj3d.matrix);this.scene=t,this.camera=t.camera,this.canvas=t.canvas,this.rect=t.rect,this.bindHandlers(),this.hovered=[],this.scene.mode="",this.subsequent=!1}toJSON(){return{obj3d:this.obj3d,objIdx:JSON.stringify(this.objIdx,Ft),linkedObjs:JSON.stringify(this.linkedObjs,Ft),l_id:this.l_id,constraints:JSON.stringify(this.constraints,Ft),c_id:this.c_id}}bindHandlers(){this.drawOnClick1=k.Mh.bind(this),this.drawPreClick2=k.NB.bind(this),this.drawOnClick2=k.H3.bind(this),this.drawPreClick3=k.or.bind(this),this.drawOnClick3=k.Sg.bind(this),this.drawDimension=L.bind(this),this._onMoveDimension=I.bind(this),this.setDimLines=C.bind(this),this.updateDim=z.bind(this),this.awaitSelection=D.FE.bind(this),this.onHover=Lt.bind(this),this.onPick=zt.bind(this),this.onDrag=Tt.bind(this),this.onRelease=At.bind(this),this.onKeyPress=this.onKeyPress.bind(this),this.setHover=D.GZ.bind(this),this.clearSelection=It.bind(this)}setClean(){this.hasChanged=!1,this.idOnActivate=id,this.c_idOnActivate=this.c_id;const t=e=>{this.scene.selected.length&&e.buttons&&(this.canvas.removeEventListener("pointermove",t),this.hasChanged=!0)};this.canvas.addEventListener("pointermove",t)}activate(){window.addEventListener("keydown",this.onKeyPress),this.canvas.addEventListener("pointerdown",this.onPick),this.canvas.addEventListener("pointermove",this.onHover),this.setDimLines(),this.obj3d.traverse((t=>t.layers.enable(2))),this.obj3d.visible=!0,this.scene.axes.matrix=this.obj3d.matrix,this.scene.axes.visible=!0,this.scene.activeSketch=this,window.sketcher=this,this.setClean()}deactivate(){window.removeEventListener("keydown",this.onKeyPress),this.canvas.removeEventListener("pointerdown",this.onPick),this.canvas.removeEventListener("pointermove",this.onHover),this.labelContainer.innerHTML="",this.obj3d.visible=!1,this.obj3d.traverse((t=>t.layers.disable(2))),this.scene.axes.visible=!1,this.scene.activeSketch=null,this.scene.newSketch&&(this.scene.newSketch=!1),this.clearSelection()}align(t,e,s){const i=D.fW.subVectors(s,t).normalize(),n=Ht.elements;Nt.subVectors(e,t).normalize(),Wt.crossVectors(Nt,i).normalize(),qt.crossVectors(Wt,Nt),n[0]=Nt.x,n[4]=qt.x,n[8]=Wt.x,n[1]=Nt.y,n[5]=qt.y,n[9]=Wt.y,n[2]=Nt.z,n[6]=qt.z,n[10]=Wt.z,this.obj3d.quaternion.setFromRotationMatrix(Ht);const o=this.obj3d.parent;Ht.extractRotation(o.matrixWorld),Rt.setFromRotationMatrix(Ht),this.obj3d.quaternion.premultiply(Rt.invert()),this.obj3d.updateMatrix(),this.obj3d.matrix.setPosition(t),this.plane.applyMatrix4(this.obj3d.matrix),this.obj3d.inverse=this.obj3d.matrix.clone().invert()}onKeyPress(t){if(t.isTrusted&&"Escape"==t.key)this.disableLineHover=!1,k.BT.call(this),this.scene.store.dispatch({type:"set-mode",mode:""});else{const e={l:"line",a:"arc",p:"point",d:"dimension",c:"coincident",v:"vertical",h:"horizontal",t:"tangent",Delete:"delete",Backspace:"delete"};this.command(e[t.key])}}command(t){let e;switch(this.disableLineHover=!1,k.BT.call(this),t){case"delete":this.deleteSelected();break;case"coincident":case"vertical":case"horizontal":case"tangent":window.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape"}));case"line":case"arc":case"point":case"dimension":if(this.scene.mode==t)e="";else switch(e=t,t){case"line":case"arc":this.disableLineHover=!0,this.canvas.addEventListener("pointerdown",this.drawOnClick1,{once:!0});break;case"point":this.disableLineHover=!0,this.canvas.addEventListener("pointerdown",(t=>{if("point"!==this.scene.mode)return;const e=(0,D.J1)();e.matrixAutoUpdate=!1,e.userData.constraints=[],e.geometry.attributes.position.set(this.getLocation(t).toArray()),e.layers.enable(2),this.obj3d.add(e),this.updatePointsBuffer(this.obj3d.children.length-1),this.scene.render()}));break;case"dimension":this.drawDimension();break;case"coincident":case"vertical":case"horizontal":case"tangent":Ct.call(this).then((()=>this.scene.store.dispatch({type:"set-mode",mode:""})))}}void 0!==e&&this.scene.store.dispatch({type:"set-mode",mode:e})}deleteSelected(){this.scene.selected.filter((t=>"dimension"==t.userData.type)).forEach((t=>this.constraints.has(t.name)&&this.deleteConstraints(t.name)));const t=this.scene.selected.filter((t=>"line"==t.userData.type)).sort(((t,e)=>e.id-t.id)).map((t=>this.delete(t)));t.length&&this.updatePointsBuffer(t[t.length-1]),this.updateOtherBuffers(),this.scene.store.dispatch({type:"clear-selection"}),this.scene.render()}delete(t){if(!t)return;if("dimension"==t.userData.type)return void this.deleteConstraints(t.name);let e=this.linkedObjs.get(t.userData.l_id);if(!e)return;e=e[1];let s=this.objIdx.get(e[0])||this.updatePoint;for(let t=0;t<e.length;t++){const e=this.obj3d.children[s+t];e.traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}));let i,n=[];for(let t of e.userData.constraints.slice())i=this.constraints.get(t),"points_coincident"==i[0]&&n.push(i[2][0]==e.name?i[2][1]:i[2][0]),this.deleteConstraints(t);for(let t=0;t<n.length-1;t++)Ct.call(this,[this.obj3d.children[this.objIdx.get(n[t])],this.obj3d.children[this.objIdx.get(n[t+1])]]);e.userData.constraints=[]}return this.obj3d.children.splice(s,e.length),this.linkedObjs.delete(t.userData.l_id),s}deleteConstraints(t){for(let e of this.constraints.get(t)[2]){if(-1==e)continue;const s=this.obj3d.children[this.objIdx.get(e)];s&&s.userData.constraints.splice(s.userData.constraints.indexOf(t),1)}this.constraints.delete(t);for(let e=0;e<this.dimGroup.children.length;e++)if(this.dimGroup.children[e].name==t){this.dimGroup.children.splice(e,e+2).forEach((t=>{t.label&&t.label.remove(),t.geometry.dispose(),t.material.dispose()}));break}}updateOtherBuffers(){let t=0;for(let[e,s]of this.constraints)this.constraintsBuf.set([this.constraintNum[s[0]],s[1],...s[2].map((t=>this.objIdx.get(t)??0)),s[3],s[4]],8*t),t++;t=0;for(let[e,s]of this.linkedObjs)this.linksBuf.set([this.linkNum[s[0]],...s[1].map((t=>this.objIdx.get(t)??-1))],5*t),t++}updatePointsBuffer(t=0){for(let e=t;e<this.obj3d.children.length;e++){const t=this.obj3d.children[e];this.objIdx.set(t.name,e),"Points"==t.type&&this.ptsBuf.set(t.geometry.attributes.position.array,3*e)}}updateBoundingSpheres(){for(let t=this.geomStartIdx;t<this.obj3d.children.length;t++){this.obj3d.children[t].geometry.computeBoundingSphere()}for(let t=0;t<this.dimGroup.children.length;t++){this.dimGroup.children[t].geometry.computeBoundingSphere()}}getLocation(t){return D.KW.setFromCamera(D.Ti.set((t.clientX-this.rect.left)/this.rect.width*2-1,-(t.clientY-this.rect.top)/this.rect.height*2+1),this.camera),D.KW.ray.intersectPlane(this.plane,D.fW).applyMatrix4(this.obj3d.inverse),D.fW}getScreenXY(t){return D.fW.set(...t).applyMatrix4(this.obj3d.matrix).project(this.camera)}solve(){const t=Module._malloc(this.ptsBuf.length*this.ptsBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.ptsBuf,t>>2);const e=Module._malloc(this.constraintsBuf.length*this.constraintsBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.constraintsBuf,e>>2);const s=Module._malloc(this.linksBuf.length*this.linksBuf.BYTES_PER_ELEMENT);Module.HEAPF32.set(this.linksBuf,s>>2),Module._solver(this.obj3d.children.length,t,this.constraints.size,e,this.linkedObjs.size,s,this.geomStartIdx);for(let e=this.geomStartIdx,s=(t>>2)+3*this.geomStartIdx;e<this.obj3d.children.length;e+=1,s+=3){const t=this.obj3d.children[e].geometry.attributes.position;isNaN(Module.HEAPF32[s])?(t.array[0]=Module.HEAPF32[s-6],t.array[1]=Module.HEAPF32[s-5],t.array[3]=Module.HEAPF32[s-3],t.array[4]=Module.HEAPF32[s-2]):(t.array[0]=Module.HEAPF32[s],t.array[1]=Module.HEAPF32[s+1]),t.needsUpdate=!0}Module._free(t),Module._free(s),Module._free(e);for(let[t,e]of this.linkedObjs){if("arc"!=e[0])continue;const[t,s,i,n]=e[1].map((t=>this.obj3d.children[this.objIdx.get(t)]));let o;o=(0,Bt.JG)(t.geometry.attributes.position.array,s.geometry.attributes.position.array,i.geometry.attributes.position.array),n.geometry.attributes.position.set(o),n.needsUpdate=!0}this.setDimLines()}}const Ht=new j.y,Rt=new E._,Nt=new w.P,qt=new w.P,Wt=new w.P;Object.assign(Gt.prototype,{linkNum:{line:0,arc:1},constraintNum:{points_coincident:0,pt_pt_distance:1,pt_plane_distance:2,pt_line_distance:3,pt_face_distance:4,pt_in_plane:5,pt_on_line:6,pt_on_face:7,equal_length_lines:8,length_ratio:9,eq_len_pt_line_d:10,eq_pt_ln_distances:11,equal_angle:12,equal_line_arc_len:13,symmetric:14,symmetric_horiz:15,symmetric_vert:16,symmetric_line:17,at_midpoint:18,horizontal:19,vertical:20,diameter:21,pt_on_circle:22,same_orientation:23,angle:24,parallel:25,perpendicular:26,arc_line_tangent:27,cubic_line_tangent:28,equal_radius:29,proj_pt_distance:30,where_dragged:31,curve_curve_tangent:32,length_difference:33,h_dist:34,v_dist:35},max_pts:1e3,max_links:1e3,max_constraints:1e3});var Yt=s(3608),Ut=s(7060),Xt=s(461);function Vt(t,e){let s=t.constraints,i=t.linkedObjs,n=t.obj3d.children,o=t.objIdx,r=new Set,a=[];function l(e){if(e.userData.construction)return;r.add(e);let h,c,d,p=i.get(e.userData.l_id);if("line"==p[0]?c=p[1][2]:"arc"==p[0]&&(c=p[1][3]),h=n[o.get(c)].geometry.attributes.position.array,p[1][0]==e.name){d=1;for(let t=0;t<h.length;t+=3)a.push(new P.F(h[t],h[t+1]))}else{d=0;for(let t=h.length-3;t>=0;t-=3)a.push(new P.F(h[t],h[t+1]))}let u=n[o.get(p[1][d])];n[t.geomStartIdx+1],function(e){for(let i of e.userData.constraints)if("points_coincident"==s.get(i)[0])for(let r of s.get(i)[2]){if(-1==r)continue;const s=n[o.get(r)];s!=e&&(s==n[t.geomStartIdx+1]||l(s))}}(u)}l(n[t.geomStartIdx+1]);const c=new Yt.b(a),d={depth:e,bevelEnabled:!1},u=new Ut.O(c,d),m=new Xt.x({color:D.$_.mesh,emissive:D.$_.emissive}),y=new p.K(u,m);y.userData.type="mesh",y.userData.featureInfo=[t.obj3d.name,e],y.layers.enable(1);const b=new h.w(y.geometry,new v.U);return b.userData.type="point",b.visible=!1,b.layers.enable(1),y.add(b),y.matrixAutoUpdate=!1,y.matrix.multiply(t.obj3d.matrix),e<0&&(Zt(y.geometry),y.userData.inverted=!0),y}function Zt(t){const e=[0,0,0];for(let s=0;s<t.attributes.normal.array.length/9;s++)e[0]=t.attributes.normal.array[9*s],e[1]=t.attributes.normal.array[9*s+1],e[2]=t.attributes.normal.array[9*s+2],t.attributes.normal.array[9*s]=t.attributes.normal.array[9*s+6],t.attributes.normal.array[9*s+1]=t.attributes.normal.array[9*s+7],t.attributes.normal.array[9*s+2]=t.attributes.normal.array[9*s+8],t.attributes.normal.array[9*s+6]=e[0],t.attributes.normal.array[9*s+7]=e[1],t.attributes.normal.array[9*s+8]=e[2];for(let s=0;s<t.attributes.position.array.length/9;s++)e[0]=t.attributes.position.array[9*s],e[1]=t.attributes.position.array[9*s+1],e[2]=t.attributes.position.array[9*s+2],t.attributes.position.array[9*s]=t.attributes.position.array[9*s+6],t.attributes.position.array[9*s+1]=t.attributes.position.array[9*s+7],t.attributes.position.array[9*s+2]=t.attributes.position.array[9*s+8],t.attributes.position.array[9*s+6]=e[0],t.attributes.position.array[9*s+7]=e[1],t.attributes.position.array[9*s+8]=e[2];for(let s=0;s<t.attributes.uv.array.length/6;s++)e[0]=t.attributes.uv.array[6*s],e[1]=t.attributes.uv.array[6*s+1],t.attributes.uv.array[6*s]=t.attributes.uv.array[6*s+4],t.attributes.uv.array[6*s+1]=t.attributes.uv.array[6*s+5],t.attributes.uv.array[6*s+4]=e[0],t.attributes.uv.array[6*s+5]=e[1];t.attributes.normal.needsUpdate=!0,t.attributes.position.needsUpdate=!0,t.attributes.uv.needsUpdate=!0}var Kt=s(5353),$t=s(7289);class Jt extends Kt.T{constructor(t=1){return super(),this.matrixAutoUpdate=!1,this.initialZoom=t,this.length=[5.5,10],this.headLength=2.5,this.headWidth=1.2,this.dirs=[[1,0,0],[0,1,0]],this.add(...this.dirs.map(((t,e)=>new $t.t(new w.P(...t),new w.P(0,0,0),this.length[e],13377306,this.headLength,this.headWidth)))),this}resize(t){const e=this.initialZoom/t;for(let t=0;t<this.children.length;t++)this.children[t].setLength(this.length[t]*e,this.headLength*e,this.headWidth*e)}}var Qt=s(7406),te=function(t,e){void 0===e&&console.warn('THREE.TrackballControls: The second parameter "domElement" is now mandatory.'),e===document&&console.error('THREE.TrackballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.');var s=this,i=-1,n=0,o=1,r=2,a=3,h=4;this.object=t,this.domElement=e,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=3,this.zoomSpeed=1.2,this.panSpeed=2,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!0,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.mouseButtons={LEFT:null,MIDDLE:m.RsA.PAN,RIGHT:m.RsA.ROTATE},this.target=new w.P;var l=1e-6,c=new w.P,d=1,p=i,u=i,y=new w.P,b=new P.F,g=new P.F,f=new w.P,v=0,x=new P.F,j=new P.F,D=0,k=0,_=new P.F,S=new P.F;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom;var M={type:"change"},L={type:"start"},z={type:"end"};this.handleResize=function(){var t=s.domElement.getBoundingClientRect(),e=s.domElement.ownerDocument.documentElement;s.screen.left=t.left+window.pageXOffset-e.clientLeft,s.screen.top=t.top+window.pageYOffset-e.clientTop,s.screen.width=t.width,s.screen.height=t.height};var T,A,I,C,B,F,O,G,H,R,N,q=(T=new P.F,function(t,e){return T.set((t-s.screen.left)/s.screen.width,(e-s.screen.top)/s.screen.height),T}),W=function(){var t=new P.F;return function(e,i){return t.set((e-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(s.screen.height+2*(s.screen.top-i))/s.screen.width),t}}();function Y(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(t.preventDefault(),t.stopPropagation(),p===i)switch(t.button){case 0:p=s.mouseButtons.LEFT;break;case 1:p=s.mouseButtons.MIDDLE;break;case 2:p=t.ctrlKey?s.mouseButtons.MIDDLE:s.mouseButtons.RIGHT;break;default:p=i}var e=u!==i?u:p;e!==n||s.noRotate?e!==o||s.noZoom?e!==r||s.noPan||(_.copy(q(t.pageX,t.pageY)),S.copy(_)):(x.copy(q(t.pageX,t.pageY)),j.copy(x)):(g.copy(W(t.pageX,t.pageY)),b.copy(g));s.domElement.ownerDocument.addEventListener("pointermove",U),s.domElement.ownerDocument.addEventListener("pointerup",X),s.dispatchEvent(L)}(t)}}function U(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1===s.enabled)return;t.preventDefault(),t.stopPropagation();var e=u!==i?u:p;e!==n||s.noRotate?e!==o||s.noZoom?e!==r||s.noPan||S.copy(q(t.pageX,t.pageY)):j.copy(q(t.pageX,t.pageY)):(b.copy(g),g.copy(W(t.pageX,t.pageY)));s.update()}(t)}}function X(t){if(!1!==s.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1===s.enabled)return;t.preventDefault(),t.stopPropagation(),p=i,s.domElement.ownerDocument.removeEventListener("pointermove",U),s.domElement.ownerDocument.removeEventListener("pointerup",X),s.dispatchEvent(z)}(t)}}function V(t){!1!==s.enabled&&(window.removeEventListener("keydown",V),u===i&&(t.keyCode!==s.keys[n]||s.noRotate?t.keyCode!==s.keys[o]||s.noZoom?t.keyCode!==s.keys[r]||s.noPan||(u=r):u=o:u=n))}function Z(){!1!==s.enabled&&(u=i,window.addEventListener("keydown",V))}function K(t){if(!1!==s.enabled&&!0!==s.noZoom){switch(t.preventDefault(),t.stopPropagation(),t.deltaMode){case 2:x.y-=.025*t.deltaY;break;case 1:x.y-=.01*t.deltaY;break;default:x.y-=25e-5*t.deltaY}s.update(),s.dispatchEvent(L),s.dispatchEvent(z)}}function $(t){if(!1!==s.enabled){switch(t.preventDefault(),t.touches.length){case 1:p=a,g.copy(W(t.touches[0].pageX,t.touches[0].pageY)),b.copy(g);break;default:p=h;var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;k=D=Math.sqrt(e*e+i*i);var n=(t.touches[0].pageX+t.touches[1].pageX)/2,o=(t.touches[0].pageY+t.touches[1].pageY)/2;_.copy(q(n,o)),S.copy(_)}s.dispatchEvent(L)}}function J(t){if(!1!==s.enabled){switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:b.copy(g),g.copy(W(t.touches[0].pageX,t.touches[0].pageY));break;default:var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;k=Math.sqrt(e*e+i*i);var n=(t.touches[0].pageX+t.touches[1].pageX)/2,o=(t.touches[0].pageY+t.touches[1].pageY)/2;S.copy(q(n,o))}s.update()}}function Q(t){if(!1!==s.enabled){switch(t.touches.length){case 0:p=i;break;case 1:p=a,g.copy(W(t.touches[0].pageX,t.touches[0].pageY)),b.copy(g)}s.dispatchEvent(z)}}function tt(t){!1!==s.enabled&&t.preventDefault()}this.rotateCamera=(I=new w.P,C=new E._,B=new w.P,F=new w.P,O=new w.P,G=new w.P,function(){G.set(g.x-b.x,g.y-b.y,0),(A=G.length())?(y.copy(s.object.position).sub(s.target),B.copy(y).normalize(),F.copy(s.object.up).normalize(),O.crossVectors(F,B).normalize(),F.setLength(g.y-b.y),O.setLength(g.x-b.x),G.copy(F.add(O)),I.crossVectors(G,y).normalize(),A*=s.rotateSpeed,C.setFromAxisAngle(I,A),y.applyQuaternion(C),s.object.up.applyQuaternion(C),f.copy(I),v=A):!s.staticMoving&&v&&(v*=Math.sqrt(1-s.dynamicDampingFactor),y.copy(s.object.position).sub(s.target),C.setFromAxisAngle(f,v),y.applyQuaternion(C),s.object.up.applyQuaternion(C)),b.copy(g)}),this.zoomCamera=function(){var t;p===h?(t=k/D,D=k,s.object.isPerspectiveCamera?y.multiplyScalar(t):s.object.isOrthographicCamera?(s.object.zoom*=t,s.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(1!==(t=1+(j.y-x.y)*s.zoomSpeed)&&t>0&&(s.object.isPerspectiveCamera?y.multiplyScalar(t):s.object.isOrthographicCamera?(s.object.zoom/=t,s.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),s.staticMoving?x.copy(j):x.y+=(j.y-x.y)*this.dynamicDampingFactor)},this.panCamera=(H=new P.F,R=new w.P,N=new w.P,function(){if(H.copy(S).sub(_),H.lengthSq()){if(s.object.isOrthographicCamera){var t=(s.object.right-s.object.left)/s.object.zoom/s.domElement.clientWidth,e=(s.object.top-s.object.bottom)/s.object.zoom/s.domElement.clientWidth;H.x*=t,H.y*=e}H.multiplyScalar(1*y.length()/577*s.domElement.clientWidth),N.copy(y).cross(s.object.up).setLength(H.x),N.add(R.copy(s.object.up).setLength(H.y)),s.object.position.add(N),s.target.add(N),s.staticMoving?_.copy(S):_.add(H.subVectors(S,_).multiplyScalar(s.dynamicDampingFactor))}}),this.checkDistances=function(){s.noZoom&&s.noPan||(y.lengthSq()>s.maxDistance*s.maxDistance&&(s.object.position.addVectors(s.target,y.setLength(s.maxDistance)),x.copy(j)),y.lengthSq()<s.minDistance*s.minDistance&&(s.object.position.addVectors(s.target,y.setLength(s.minDistance)),x.copy(j)))},this.update=function(){y.subVectors(s.object.position,s.target),s.noRotate||s.rotateCamera(),s.noZoom||s.zoomCamera(),s.noPan||s.panCamera(),s.object.position.addVectors(s.target,y),s.object.isPerspectiveCamera?(s.checkDistances(),s.object.lookAt(s.target),c.distanceToSquared(s.object.position)>l&&(s.dispatchEvent(M),c.copy(s.object.position))):s.object.isOrthographicCamera?(s.object.lookAt(s.target),(c.distanceToSquared(s.object.position)>l||d!==s.object.zoom)&&(s.dispatchEvent(M),c.copy(s.object.position),d=s.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")},this.reset=function(){p=i,u=i,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),y.subVectors(s.object.position,s.target),s.object.lookAt(s.target),s.dispatchEvent(M),c.copy(s.object.position),d=s.object.zoom},this.dispose=function(){s.domElement.removeEventListener("contextmenu",tt),s.domElement.removeEventListener("pointerdown",Y),s.domElement.removeEventListener("wheel",K),s.domElement.removeEventListener("touchstart",$),s.domElement.removeEventListener("touchend",Q),s.domElement.removeEventListener("touchmove",J),s.domElement.ownerDocument.removeEventListener("pointermove",U),s.domElement.ownerDocument.removeEventListener("pointerup",X),window.removeEventListener("keydown",V),window.removeEventListener("keyup",Z)},this.domElement.addEventListener("contextmenu",tt),this.domElement.addEventListener("pointerdown",Y),this.domElement.addEventListener("wheel",K),this.domElement.addEventListener("touchstart",$),this.domElement.addEventListener("touchend",Q),this.domElement.addEventListener("touchmove",J),this.domElement.ownerDocument.addEventListener("pointermove",U),this.domElement.ownerDocument.addEventListener("pointerup",X),window.addEventListener("keydown",V),window.addEventListener("keyup",Z),this.handleResize(),this.update()};(te.prototype=Object.create(Qt.p.prototype)).constructor=te;var ee=s(1273);class se{constructor(){this.polygons=[]}clone(){let t=new se;return t.polygons=this.polygons.map((function(t){return t.clone()})),t}toPolygons(){return this.polygons}union(t){let e=new le(this.clone().polygons),s=new le(t.clone().polygons);return e.clipTo(s),s.clipTo(e),s.invert(),s.clipTo(e),s.invert(),e.build(s.allPolygons()),se.fromPolygons(e.allPolygons())}subtract(t){let e=new le(this.clone().polygons),s=new le(t.clone().polygons);return e.invert(),e.clipTo(s),s.clipTo(e),s.invert(),s.clipTo(e),s.invert(),e.build(s.allPolygons()),e.invert(),se.fromPolygons(e.allPolygons())}intersect(t){let e=new le(this.clone().polygons),s=new le(t.clone().polygons);return e.invert(),s.clipTo(e),s.invert(),e.clipTo(s),s.clipTo(e),e.build(s.allPolygons()),e.invert(),se.fromPolygons(e.allPolygons())}inverse(){let t=this.clone();return t.polygons.forEach((t=>t.flip())),t}}se.fromPolygons=function(t){let e=new se;return e.polygons=t,e};class ie{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new ie(this.x,this.y,this.z)}negate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}times(t){return this.x*=t,this.y*=t,this.z*=t,this}dividedBy(t){return this.x/=t,this.y/=t,this.z/=t,this}lerp(t,e){return this.add(ne.copy(t).sub(this).times(e))}unit(){return this.dividedBy(this.length())}length(){return Math.sqrt(this.x**2+this.y**2+this.z**2)}normalize(){return this.unit()}cross(t){let e=this;const s=e.x,i=e.y,n=e.z,o=t.x,r=t.y,a=t.z;return this.x=i*a-n*r,this.y=n*o-s*a,this.z=s*r-i*o,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}}let ne=new ie,oe=new ie;class re{constructor(t,e,s,i){this.pos=(new ie).copy(t),this.normal=(new ie).copy(e),this.uv=(new ie).copy(s),this.uv.z=0,i&&(this.color=(new ie).copy(i))}clone(){return new re(this.pos,this.normal,this.uv,this.color)}flip(){this.normal.negate()}interpolate(t,e){return new re(this.pos.clone().lerp(t.pos,e),this.normal.clone().lerp(t.normal,e),this.uv.clone().lerp(t.uv,e),this.color&&t.color&&this.color.clone().lerp(t.color,e))}}class ae{constructor(t,e){this.normal=t,this.w=e}clone(){return new ae(this.normal.clone(),this.w)}flip(){this.normal.negate(),this.w=-this.w}splitPolygon(t,e,s,i,n){let o=0,r=[];for(let e=0;e<t.vertices.length;e++){let s=this.normal.dot(t.vertices[e].pos)-this.w,i=s<-ae.EPSILON?2:s>ae.EPSILON?1:0;o|=i,r.push(i)}switch(o){case 0:(this.normal.dot(t.plane.normal)>0?e:s).push(t);break;case 1:i.push(t);break;case 2:n.push(t);break;case 3:let o=[],a=[];for(let e=0;e<t.vertices.length;e++){let s=(e+1)%t.vertices.length,i=r[e],n=r[s],h=t.vertices[e],l=t.vertices[s];if(2!=i&&o.push(h),1!=i&&a.push(2!=i?h.clone():h),3==(i|n)){let t=(this.w-this.normal.dot(h.pos))/this.normal.dot(ne.copy(l.pos).sub(h.pos)),e=h.interpolate(l,t);o.push(e),a.push(e.clone())}}o.length>=3&&i.push(new he(o,t.shared)),a.length>=3&&n.push(new he(a,t.shared))}}}ae.EPSILON=1e-5,ae.fromPoints=function(t,e,s){let i=ne.copy(e).sub(t).cross(oe.copy(s).sub(t)).normalize();return new ae(i.clone(),i.dot(t))};class he{constructor(t,e){this.vertices=t,this.shared=e,this.plane=ae.fromPoints(t[0].pos,t[1].pos,t[2].pos)}clone(){return new he(this.vertices.map((t=>t.clone())),this.shared)}flip(){this.vertices.reverse().map((t=>t.flip())),this.plane.flip()}}class le{constructor(t){this.plane=null,this.front=null,this.back=null,this.polygons=[],t&&this.build(t)}clone(){let t=new le;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map((t=>t.clone())),t}invert(){for(let t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();let t=this.front;this.front=this.back,this.back=t}clipPolygons(t){if(!this.plane)return t.slice();let e=[],s=[];for(let i=0;i<t.length;i++)this.plane.splitPolygon(t[i],e,s,e,s);return this.front&&(e=this.front.clipPolygons(e)),s=this.back?this.back.clipPolygons(s):[],e.concat(s)}clipTo(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)}allPolygons(){let t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t}build(t){if(!t.length)return;this.plane||(this.plane=t[0].plane.clone());let e=[],s=[];for(let i=0;i<t.length;i++)this.plane.splitPolygon(t[i],this.polygons,this.polygons,e,s);e.length&&(this.front||(this.front=new le),this.front.build(e)),s.length&&(this.back||(this.back=new le),this.back.build(s))}}se.fromJSON=function(t){return se.fromPolygons(t.polygons.map((t=>new he(t.vertices.map((t=>new re(t.pos,t.normal,t.uv))),t.shared))))},se.fromGeometry=function(t,e){if(!t.isBufferGeometry)return void console.error("Unsupported CSG input type:"+t.type);let s,i=[],n=t.attributes.position,o=t.attributes.normal,r=t.attributes.uv,a=t.attributes.color;if(t.index)s=t.index.array;else{s=new Array(n.array.length/n.itemSize|0);for(let t=0;t<s.length;t++)s[t]=t}let h=s.length/3|0;i=new Array(h);for(let t=0,h=0,l=s.length;t<l;t+=3,h++){let l=new Array(3);for(let e=0;e<3;e++){let i=s[t+e],h=3*i,c=2*i,d=n.array[h],p=n.array[h+1],u=n.array[h+2],m=o.array[h],y=o.array[h+1],b=o.array[h+2],g=r.array[c],f=r.array[c+1];l[e]=new re({x:d,y:p,z:u},{x:m,y,z:b},{x:g,y:f,z:0},a&&{x:a.array[c],y:a.array[c+1],z:a.array[c+2]})}i[h]=new he(l,e)}return se.fromPolygons(i)};let ce=new w.P,de=new ee.V;se.fromMesh=function(t,e){let s=se.fromGeometry(t.geometry,e);de.getNormalMatrix(t.matrix);for(let e=0;e<s.polygons.length;e++){let i=s.polygons[e];for(let e=0;e<i.vertices.length;e++){let s=i.vertices[e];s.pos.copy(ce.copy(s.pos).applyMatrix4(t.matrix)),s.normal.copy(ce.copy(s.normal).applyMatrix3(de))}}return s};let pe=t=>({top:0,array:new Float32Array(t),write:function(t){this.array[this.top++]=t.x,this.array[this.top++]=t.y,this.array[this.top++]=t.z}}),ue=t=>({top:0,array:new Float32Array(t),write:function(t){this.array[this.top++]=t.x,this.array[this.top++]=t.y}});se.toMesh=function(t,e,s){let i,n,o=t.polygons;{let t=0;o.forEach((e=>t+=e.vertices.length-2)),i=new l.u;let e,s=pe(3*t*3),r=pe(3*t*3),a=ue(2*t*3),h=[];if(o.forEach((i=>{let n=i.vertices,o=n.length;void 0!==i.shared&&(h[i.shared]||(h[i.shared]=[])),o&&void 0!==n[0].color&&(e||(e=pe(3*t*3)));for(let t=3;t<=o;t++)void 0!==i.shared&&h[i.shared].push(s.top/3,s.top/3+1,s.top/3+2),s.write(n[0].pos),s.write(n[t-2].pos),s.write(n[t-1].pos),r.write(n[0].normal),r.write(n[t-2].normal),r.write(n[t-1].normal),a.write(n[0].uv),a.write(n[t-2].uv),a.write(n[t-1].uv),e&&(e.write(n[0].color)||e.write(n[t-2].color)||e.write(n[t-1].color))})),i.setAttribute("position",new c.Tl(s.array,3)),i.setAttribute("normal",new c.Tl(r.array,3)),i.setAttribute("uv",new c.Tl(a.array,2)),e&&i.setAttribute("color",new c.Tl(e.array,3)),h.length){let t=[],e=0;for(let s=0;s<h.length;s++)i.addGroup(e,h[s].length,s),e+=h[s].length,t=t.concat(h[s]);i.setIndex(t)}n=i}let r=(new j.y).copy(e).invert();i.applyMatrix4(r),i.computeBoundingSphere(),i.computeBoundingBox();let a=new p.K(i,s);return a.matrix.copy(e),a.matrix.decompose(a.position,a.quaternion,a.scale),a.rotation.setFromQuaternion(a.quaternion),a.updateMatrixWorld(),a.castShadow=a.receiveShadow=!0,a};const me=se;var ye=function(){};let be,ge,fe,ve,we,xe,je;ye.prototype={constructor:ye,parse:function(t,e){void 0===e&&(e={});var s,i=void 0!==e.binary&&e.binary,n=[],o=0;t.traverse((function(t){if(t.isMesh){var e=t.geometry;if(!0!==e.isBufferGeometry)throw new Error("THREE.STLExporter: Geometry is not of type THREE.BufferGeometry.");var s=e.index,i=e.getAttribute("position");o+=null!==s?s.count/3:i.count/3,n.push({object3d:t,geometry:e})}}));var r=80;if(!0===i){var a=new ArrayBuffer(2*o+3*o*4*4+80+4);(s=new DataView(a)).setUint32(r,o,!0),r+=4}else s="",s+="solid exported\n";for(var h=new w.P,l=new w.P,c=new w.P,d=new w.P,p=new w.P,u=new w.P,m=0,y=n.length;m<y;m++){var b=n[m].object3d,g=n[m].geometry,f=g.index,v=g.getAttribute("position");if(null!==f)for(var x=0;x<f.count;x+=3){j(f.getX(x+0),f.getX(x+1),f.getX(x+2),v,b)}else for(x=0;x<v.count;x+=3){j(x+0,x+1,x+2,v,b)}}return!1===i&&(s+="endsolid exported\n"),s;function j(t,e,n,o,a){h.fromBufferAttribute(o,t),l.fromBufferAttribute(o,e),c.fromBufferAttribute(o,n),!0===a.isSkinnedMesh&&(a.boneTransform(t,h),a.boneTransform(e,l),a.boneTransform(n,c)),h.applyMatrix4(a.matrixWorld),l.applyMatrix4(a.matrixWorld),c.applyMatrix4(a.matrixWorld),function(t,e,n){d.subVectors(n,e),p.subVectors(t,e),d.cross(p).normalize(),u.copy(d).normalize(),!0===i?(s.setFloat32(r,u.x,!0),r+=4,s.setFloat32(r,u.y,!0),r+=4,s.setFloat32(r,u.z,!0),r+=4):(s+="\tfacet normal "+u.x+" "+u.y+" "+u.z+"\n",s+="\t\touter loop\n")}(h,l,c),E(h),E(l),E(c),!0===i?(s.setUint16(r,0,!0),r+=2):(s+="\t\tendloop\n",s+="\tendfacet\n")}function E(t){!0===i?(s.setFloat32(r,t.x,!0),r+=4,s.setFloat32(r,t.y,!0),r+=4,s.setFloat32(r,t.z,!0),r+=4):s+="\t\t\tvertex "+t.x+" "+t.y+" "+t.z+"\n"}}},window.loader=new i.G,window.STLexp=new ye,window.id=0;class Ee{constructor(t){this.sid=1,this.mid=1,this.canvas=document.querySelector("#c"),this.rect=this.canvas.getBoundingClientRect().toJSON(),this.renderer=new n.C({canvas:this.canvas}),this.store=t;this.camera=new o.i(-1,1,1,-1,-1,1e3),this.camera.zoom=.008;const e=30*Math.PI/180;this.camera.position.set(500*Math.sin(e),500*Math.tan(30*Math.PI/180),500*Math.cos(e)),this.camera.layers.enable(3),this.controls=new te(this.camera,this.canvas),this.controls.target.set(0,0,0),this.controls.update(),this.obj3d=new r.x;const s=new a.Z;s.name="helpers",this.obj3d.add(s);for(let t=0;t<4;t++){const t=new h.w((new l.u).setAttribute("position",new c.a$(3,3)),D.Em.clone());t.matrixAutoUpdate=!1,t.visible=!1,t.renderOrder=1,t.userData.type="selpoint",s.add(t)}this.selpoints=this.obj3d.children[0].children,this.fptIdx=0,this.fptObj={};const i=new d._(50,50),v=new p.K(i,new u.v({color:D.$_.plane,opacity:.02,side:m.ehD,transparent:!0,depthWrite:!1,toneMapped:!1}));v.add(new y.e(new b.T(i),new g.n({color:D.$_.planeBorder}))),v.userData.type="plane",v.layers.enable(1),v.children[0].layers.disable(1);const w=v.clone().rotateY(Math.PI/2),x=v.clone().rotateX(-Math.PI/2);s.add(v),[x,w].forEach((t=>{t.traverse((t=>t.material=t.material.clone())),s.add(t)})),this.axes=new Jt(this.camera.zoom),this.axes.visible=!1,s.add(this.axes);const j=500,E=new f.c(D.$_.lighting,.7);E.position.set(j,j,j),s.add(E);const k=new f.c(D.$_.lighting,.7);k.position.set(-500,-500,-500),s.add(k),this.render=De.bind(this),this.addSketch=ke.bind(this),this.onHover=Lt.bind(this),this.onPick=zt.bind(this),this.clearSelection=It.bind(this),this.setHover=D.GZ.bind(this),this.awaitSelection=D.FE.bind(this),this.extrude=this.extrude.bind(this),this.obj3d.addEventListener("change",this.render),this.controls.addEventListener("change",this.render),this.controls.addEventListener("start",this.render),window.addEventListener("resize",this.render),this.hovered=[],this.activeSketch=null,this.selected=[],this.mode="",this.store.subscribe(this.reduxCallback.bind(this)),this.render()}reduxCallback(){const t=this.store.getState().ui.selectedList,e=this.store.getState().ui.mode;t!==this.selected&&(this.selected=t),e!==this.mode&&(this.mode=e)}resizeCanvas(t){const e=t.domElement,s=e.clientWidth,i=e.clientHeight,n=e.width!==s||e.height!==i;return n&&t.setSize(s,i,!1),n}clearScene(){const t=this.obj3d.children.splice(1);for(let e=0;e<t.length;e++)t[e].traverse((t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))}newPart(){this.clearScene(),window.id=0,this.sid=1,this.mid=1}loadState(t){this.clearScene();const[e,s,i,n]=JSON.parse(t);window.id=e,this.sid=s,this.mid=i;const o=n.byId;for(let t in o)"s"==t[0]?(o[t].obj3d=loader.parse(o[t].obj3d),this.obj3d.add(o[t].obj3d),o[t]=new Gt(this,o[t]),o[t].obj3d.addEventListener("change",this.render)):"e"==t[0]?(o[t]=loader.parse(n.byId[t]),o[t].userData.inverted&&Zt(o[t].geometry),this.obj3d.add(o[t])):(o[t]=loader.parse(n.byId[t]),this.obj3d.add(o[t]));return n}loadSketch(t){let e=JSON.parse(t);return e.obj3d=loader.parse(e.obj3d),e=new Gt(this,e),e.obj3d.addEventListener("change",this.render),e}extrude(t,e){const s=Vt(t,e);return s.name="e"+this.mid++,this.obj3d.add(s),s}boolOp(t,e,s){let i,n,o=me.fromMesh(t),r=me.fromMesh(e);switch(t.visible=!1,e.visible=!1,t.traverse((t=>t.layers.disable(1))),e.traverse((t=>t.layers.disable(1))),s){case"s":i=o.subtract(r),n="-";break;case"u":i=o.union(r),n="∪";break;case"i":i=o.intersect(r),n="∩"}let a=me.toMesh(i,t.matrix,t.material);a.userData.type="mesh",a.userData.featureInfo=[t.name,e.name,s],a.name=`(${t.name} ${n} ${e.name})`,a.layers.enable(1);const l=new h.w(a.geometry,new v.U);return l.visible=!1,l.userData.type="point",l.layers.enable(1),a.add(l),a}refreshNode(t,{byId:e,tree:s}){let i,n=[t],o=0;for(;o<n.length;){if(i=n[o++],e[i].userData){const t=e[i].userData.featureInfo;let s;2==t.length?s=Vt(e[t[0]],t[1]):3==t.length&&(s=this.boolOp(e[t[0]],e[t[1]],t[2])),e[i].geometry.copy(s.geometry),e[i].geometry.parameters=s.geometry.parameters}for(let t in s[i])n.push(t)}}}function De(){if(this.resizeCanvas(this.renderer)){const t=this.renderer.domElement;this.camera.left=-t.clientWidth/t.clientHeight,this.camera.right=t.clientWidth/t.clientHeight,this.camera.updateProjectionMatrix(),this.controls.handleResize(),Object.assign(this.rect,this.canvas.getBoundingClientRect().toJSON())}if(this.axes&&this.axes.resize(this.camera.zoom),this.renderer.render(this.obj3d,this.camera),this.activeSketch)for(xe=this.activeSketch.dimGroup.children,je=this.activeSketch.obj3d.matrix,be=1;be<xe.length;be+=2)ve=xe[be],we=D.fW.set(...ve.geometry.attributes.position.array).applyMatrix4(je).project(this.camera),ge=(.5*we.x+.5)*this.canvas.clientWidth+10+this.rect.left,fe=(-.5*we.y+.5)*this.canvas.clientHeight+this.rect.top,ve.label.style.transform=`translate(0%, -50%) translate(${ge}px,${fe}px)`}function ke(){let t;if(3==this.selected.length&&this.selected.every((t=>"selpoint"==t.userData.type)))t=new Gt(this),this.obj3d.add(t.obj3d),t.align(...this.selected.map((t=>new w.P(...t.geometry.attributes.position.array).applyMatrix4(t.matrixWorld))));else{if(!this.selected.length||"plane"!=this.selected[0].userData.type)return;t=new Gt(this),t.obj3d.matrix=this.selected[0].matrix,t.plane.applyMatrix4(t.obj3d.matrix),t.obj3d.inverse=t.obj3d.matrix.clone().invert(),this.obj3d.add(t.obj3d)}return this.newSketch=!0,this.clearSelection(),t.obj3d.addEventListener("change",this.render),t}}}]);